<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>E-Commerce DZ v3.0.0</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
/* ============================================================
   RESET & CSS VARIABLES
   ============================================================ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --pr:#6c63ff;--pr-d:#5248d4;--pr-g:rgba(108,99,255,.28);
  --ac:#00d4ff;--ac-g:rgba(0,212,255,.2);
  --ok:#00c896;--er:#ff4757;--wa:#ffa502;--in:#3498db;
  --bg:#f0f4ff;--card:#fff;--sb:#0f0f23;
  --tx:#1a1a2e;--mu:#6b7280;--bd:#e5e7eb;
  --sh:0 4px 20px rgba(108,99,255,.1);--sh2:0 10px 40px rgba(108,99,255,.18);
  --r:14px;--rs:8px;--fn:'Cairo',sans-serif;--tr:.2s ease;--hh:60px;
}
body.dark{
  --bg:#0d0d1a;--card:#16213e;--tx:#e8eaf6;--mu:#9fa8da;--bd:#2a2a4a;
  --sh:0 4px 20px rgba(0,0,0,.4);
}
body.theme-green{--pr:#00b894;--pr-d:#00a381;--pr-g:rgba(0,184,148,.28)}
body.theme-blue{--pr:#0984e3;--pr-d:#0770c4;--pr-g:rgba(9,132,227,.28)}
body.theme-orange{--pr:#e17055;--pr-d:#c8604a;--pr-g:rgba(225,112,85,.28)}
body.theme-red{--pr:#d63031;--pr-d:#b82626;--pr-g:rgba(214,48,49,.28)}
html{font-size:15px;direction:rtl}
body{font-family:var(--fn);background:var(--bg);color:var(--tx);height:100vh;overflow:hidden;transition:background var(--tr),color var(--tr)}
button,input,select,textarea{font-family:var(--fn)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--pr);border-radius:99px}
::-webkit-scrollbar-track{background:transparent}

/* ============================================================
   LOGIN
   ============================================================ */
#login-page{
  position:fixed;inset:0;z-index:9999;background:#0d0d1a;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
.lgn-bg{
  position:absolute;inset:0;
  background:
    radial-gradient(ellipse at 25% 50%,rgba(108,99,255,.28) 0%,transparent 55%),
    radial-gradient(ellipse at 75% 50%,rgba(0,212,255,.16) 0%,transparent 55%),
    radial-gradient(ellipse at 50% 88%,rgba(108,99,255,.1) 0%,transparent 50%);
  animation:bgPulse 6s ease-in-out infinite alternate;
}
@keyframes bgPulse{0%{opacity:.65}100%{opacity:1}}
.lgn-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none}
.particle{position:absolute;border-radius:50%;animation:floatP linear infinite;opacity:.32}
@keyframes floatP{
  0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:.32}
  90%{opacity:.32}100%{transform:translateY(-20px) scale(1);opacity:0}
}
.lgn-ring{position:absolute;border-radius:50%;border:1px solid rgba(108,99,255,.13);animation:ringP 5s ease-in-out infinite}
@keyframes ringP{0%,100%{transform:scale(1);opacity:.2}50%{transform:scale(1.07);opacity:.5}}
.lgn-box{
  position:relative;z-index:2;
  background:rgba(255,255,255,.04);backdrop-filter:blur(24px);
  border:1px solid rgba(108,99,255,.22);border-radius:28px;
  padding:50px 42px;width:430px;max-width:95vw;
  box-shadow:0 0 80px rgba(108,99,255,.16),inset 0 1px 0 rgba(255,255,255,.07);
}
.lgn-logo{text-align:center;margin-bottom:34px}
.lgn-logo h1{
  font-size:2.5rem;font-weight:900;
  background:linear-gradient(135deg,#6c63ff,#00d4ff,#6c63ff);
  background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:shimmer 3s ease infinite;filter:drop-shadow(0 0 22px rgba(108,99,255,.5));
}
@keyframes shimmer{0%{background-position:0%}50%{background-position:100%}100%{background-position:0%}}
.lgn-logo p{color:rgba(255,255,255,.42);font-size:.82rem;margin-top:5px}
.lgn-field{margin-bottom:16px}
.lgn-field label{display:block;color:rgba(255,255,255,.6);font-size:.8rem;margin-bottom:6px;font-weight:600}
.lgn-field .iw{position:relative}
.lgn-field input{
  width:100%;padding:12px 15px;
  background:rgba(255,255,255,.07);border:1px solid rgba(108,99,255,.25);
  border-radius:12px;color:#fff;font-size:.93rem;outline:none;transition:var(--tr);
}
.lgn-field input:focus{border-color:var(--pr);background:rgba(108,99,255,.1);box-shadow:0 0 0 3px rgba(108,99,255,.14)}
.lgn-field input::placeholder{color:rgba(255,255,255,.25)}
.eye-btn{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;
  font-size:1rem;padding:3px;transition:color var(--tr);user-select:none;
}
.eye-btn:hover{color:var(--pr)}
.lgn-btn{
  width:100%;padding:14px;margin-top:8px;
  background:linear-gradient(135deg,var(--pr),var(--ac));
  border:none;border-radius:13px;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;
  transition:var(--tr);box-shadow:0 4px 22px rgba(108,99,255,.38);
}
.lgn-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(108,99,255,.55)}
.lgn-btn:active{transform:translateY(0)}
.lgn-err{
  background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.28);
  border-radius:10px;padding:9px 13px;color:#ff6b7a;font-size:.82rem;
  margin-bottom:13px;display:none;text-align:center;
}
.lgn-remember{display:flex;align-items:center;gap:7px;margin-top:10px;cursor:pointer;color:rgba(255,255,255,.45);font-size:.8rem}
.lgn-remember input[type=checkbox]{accent-color:var(--pr);width:14px;height:14px;cursor:pointer}

/* ============================================================
   APP SHELL
   ============================================================ */
#app{display:flex;flex-direction:column;height:100vh}

/* HEADER */
.app-hdr{
  height:var(--hh);background:var(--card);border-bottom:1px solid var(--bd);
  display:flex;align-items:center;padding:0 12px;gap:8px;
  box-shadow:var(--sh);position:relative;z-index:100;flex-shrink:0;
}
.hdr-r{display:flex;align-items:center;gap:5px;flex:0 0 auto}
.hdr-c{flex:1;text-align:center;min-width:0}
.hdr-l{display:flex;align-items:center;justify-content:flex-end;gap:6px;flex:0 0 auto}
.bti{
  width:38px;height:38px;border-radius:var(--rs);border:none;
  background:var(--bg);color:var(--mu);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1.05rem;transition:var(--tr);position:relative;flex-shrink:0;
}
.bti:hover{background:var(--pr);color:#fff}
.n-badge{
  position:absolute;top:3px;right:3px;background:var(--er);color:#fff;
  font-size:.55rem;font-weight:700;min-width:14px;height:14px;
  border-radius:99px;padding:0 3px;display:flex;align-items:center;justify-content:center;
}
.store-hdr-name{
  font-size:1.05rem;font-weight:700;
  color:var(--tx);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.app-name-glow{
  font-size:.95rem;font-weight:900;white-space:nowrap;
  background:linear-gradient(135deg,var(--pr),var(--ac));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 6px var(--pr-g));
}
.hdr-dt{display:flex;flex-direction:column;align-items:flex-end;gap:1px;margin-left:4px}
.hdr-clock{font-size:.88rem;font-weight:700;color:var(--tx);white-space:nowrap}
.hdr-date{font-size:.68rem;color:var(--mu);white-space:nowrap}
.page-title-hdr{font-size:1.05rem;font-weight:800;color:var(--tx)}

/* SIDEBAR OVERLAY */
.sb-overlay{position:fixed;inset:0;z-index:199;background:rgba(0,0,0,.5);display:none}
.sb-overlay.show{display:block}

/* SIDEBAR */
.sidebar{
  position:fixed;right:0;top:0;bottom:0;width:280px;z-index:200;
  background:var(--sb);transform:translateX(100%);
  transition:transform .28s cubic-bezier(.4,0,.2,1);
  box-shadow:-4px 0 28px rgba(0,0,0,.35);
  display:flex;flex-direction:column;overflow-y:auto;
}
.sidebar.open{transform:translateX(0)}
.sb-hdr{padding:20px 16px 13px;border-bottom:1px solid rgba(255,255,255,.07)}
.sb-logo{font-size:1.2rem;font-weight:900;background:linear-gradient(135deg,#6c63ff,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sb-close{float:left;background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;font-size:1.2rem;margin-top:-20px;transition:color var(--tr)}
.sb-close:hover{color:var(--er)}
.sb-nav{padding:8px 8px;flex:1}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:11px 13px;border-radius:var(--rs);
  color:rgba(255,255,255,.58);cursor:pointer;transition:var(--tr);
  margin-bottom:2px;font-size:.9rem;font-weight:600;
  border:none;background:none;width:100%;text-align:right;
}
.nav-item:hover{background:rgba(108,99,255,.2);color:#fff}
.nav-item.nav-active{background:var(--pr);color:#fff}
.nav-divider{border:none;border-top:1px solid rgba(255,255,255,.07);margin:5px 0}
.nav-exit{color:rgba(255,71,87,.75)!important;font-size:.95rem!important;font-weight:700!important;padding:14px 13px!important}
.nav-exit:hover{background:rgba(255,71,87,.18)!important;color:var(--er)!important}

/* APP BODY */
.app-body{flex:1;overflow:hidden;position:relative;display:flex;flex-direction:column}

/* PAGES */
.page{display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0}
.page.active{display:flex}
.pg-body{flex:1;overflow-y:auto;padding:15px 18px}
.pg-hdr{
  padding:12px 16px;border-bottom:1px solid var(--bd);
  background:var(--card);display:flex;align-items:center;gap:10px;flex-shrink:0;
}
.pg-hdr h2{font-size:1.1rem;font-weight:800;flex:1;text-align:center}
.btn-back{
  background:var(--bg);border:1px solid var(--bd);border-radius:var(--rs);
  padding:6px 12px;cursor:pointer;font-size:.8rem;color:var(--tx);
  transition:var(--tr);display:flex;align-items:center;gap:4px;
}
.btn-back:hover{background:var(--pr);color:#fff;border-color:var(--pr)}

/* ============================================================
   SALE PAGE
   ============================================================ */
#page-sale{flex-direction:column}
.sale-layout{display:flex;flex:1;overflow:hidden;position:relative}
.sale-products-panel{display:flex;flex-direction:column;overflow:hidden;position:relative;min-width:0;flex:1}
.sale-cart-panel{display:flex;flex-direction:column;overflow:hidden;position:relative;min-width:0;flex:1;border-right:3px solid var(--bd)}
.panel-wm{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  pointer-events:none;z-index:0;font-size:2.8rem;font-weight:900;
  color:var(--pr);opacity:.04;white-space:nowrap;transform:rotate(-15deg);user-select:none;
}
.panel-hdr{
  padding:8px 12px;border-bottom:1px solid var(--bd);
  display:flex;align-items:center;justify-content:space-between;
  background:var(--card);z-index:1;flex-shrink:0;
}
.panel-hdr h3{font-size:.82rem;font-weight:700;color:var(--mu)}

/* DIVIDER */
.sale-divider{
  width:6px;background:var(--bd);cursor:col-resize;flex-shrink:0;
  position:relative;z-index:10;transition:background var(--tr);
}
.sale-divider:hover,.sale-divider.dragging{background:var(--pr)}
.sale-divider::after{
  content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:2px;height:30px;background:currentColor;border-radius:99px;opacity:.4;
}

.prod-search-bar{padding:7px 10px;flex-shrink:0}
.prod-search-bar input{
  width:100%;padding:8px 13px;border:1px solid var(--bd);border-radius:var(--rs);
  background:var(--card);color:var(--tx);font-size:.85rem;outline:none;transition:var(--tr);
}
.prod-search-bar input:focus{border-color:var(--pr)}
.products-grid{
  flex:1;overflow:auto;padding:9px;
  display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));
  gap:8px;align-content:start;position:relative;z-index:1;
}
.product-card{
  background:var(--card);border:2px solid var(--bd);border-radius:var(--r);
  padding:12px 8px;text-align:center;cursor:pointer;transition:var(--tr);
  position:relative;overflow:hidden;
}
.product-card:hover{border-color:var(--pr);box-shadow:0 4px 14px var(--pr-g);transform:translateY(-2px)}
.product-card.oos{opacity:.5;cursor:not-allowed}
.product-card.oos:hover{transform:none;border-color:var(--bd);box-shadow:none}
.pc-name{font-size:.82rem;font-weight:700;margin-bottom:4px;line-height:1.3;color:var(--tx)}
.pc-price{font-size:.95rem;font-weight:900;color:var(--pr)}
.pc-stock{font-size:.7rem;color:var(--mu);margin-top:3px}
.pc-stock.low{color:var(--wa)}
.pc-stock.zero{color:var(--er)}
.no-products{grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--mu);font-size:.9rem}

.cart-items{flex:1;overflow-y:auto;padding:6px;position:relative;z-index:1}
.cart-empty-msg{text-align:center;padding:40px 20px;color:var(--mu)}
.cart-item{
  background:var(--card);border:1px solid var(--bd);border-radius:var(--rs);
  padding:8px 10px;margin-bottom:6px;
  display:grid;grid-template-columns:1fr auto auto auto auto;
  align-items:center;gap:6px;transition:var(--tr);
}
.cart-item:hover{border-color:var(--pr)}
.ci-name{font-size:.82rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.qty-ctrl{display:flex;align-items:center;gap:2px}
.qty-btn{
  width:24px;height:24px;border-radius:5px;border:1px solid var(--bd);
  background:var(--bg);cursor:pointer;font-size:.9rem;font-weight:700;
  color:var(--pr);display:flex;align-items:center;justify-content:center;transition:var(--tr);
}
.qty-btn:hover{background:var(--pr);color:#fff;border-color:var(--pr)}
.qty-inp{
  width:38px;text-align:center;border:1px solid var(--bd);border-radius:5px;
  padding:2px;background:var(--bg);color:var(--tx);font-size:.84rem;
}
.price-inp{
  width:72px;text-align:center;border:1px solid var(--bd);border-radius:5px;
  padding:4px;background:var(--bg);color:var(--tx);font-size:.82rem;
}
.ci-total{font-weight:700;font-size:.85rem;color:var(--ok);white-space:nowrap}
.del-btn{
  width:24px;height:24px;border-radius:5px;border:none;
  background:rgba(255,71,87,.1);color:var(--er);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:var(--tr);
}
.del-btn:hover{background:var(--er);color:#fff}

.cart-totals{
  border-top:2px solid var(--bd);padding:10px 12px;
  background:var(--card);position:relative;z-index:1;flex-shrink:0;
}
.totals-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px}
.total-cell{background:var(--bg);border-radius:var(--rs);padding:8px;text-align:center}
.tc-label{font-size:.7rem;color:var(--mu);margin-bottom:2px}
.tc-value{font-size:.95rem;font-weight:800;color:var(--pr)}

.sale-actions{
  display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;
  padding:8px 12px;background:var(--card);border-top:1px solid var(--bd);flex-shrink:0;
}
.sale-btn{
  padding:12px 6px;border-radius:var(--rs);border:none;
  font-size:.85rem;font-weight:700;cursor:pointer;transition:var(--tr);
  display:flex;align-items:center;justify-content:center;
}
.sale-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:var(--sh)}
.btn-pay{background:linear-gradient(135deg,var(--ok),#00a877);color:#fff}
.btn-deliver{background:linear-gradient(135deg,var(--pr),var(--ac));color:#fff}
.btn-debt{background:linear-gradient(135deg,var(--wa),#e07800);color:#fff}

/* ============================================================
   COMMON COMPONENTS
   ============================================================ */
/* Buttons */
.btn{
  padding:9px 18px;border-radius:var(--rs);border:none;cursor:pointer;
  font-size:.85rem;font-weight:700;transition:var(--tr);
  display:inline-flex;align-items:center;gap:5px;
}
.btn-pr{background:var(--pr);color:#fff}
.btn-pr:hover{background:var(--pr-d);box-shadow:var(--sh)}
.btn-ok{background:var(--ok);color:#fff}
.btn-ok:hover{filter:brightness(.9)}
.btn-er{background:var(--er);color:#fff}
.btn-er:hover{filter:brightness(.9)}
.btn-wa{background:var(--wa);color:#fff}
.btn-wa:hover{filter:brightness(.9)}
.btn-out{background:none;border:1px solid var(--bd);color:var(--tx)}
.btn-out:hover{border-color:var(--pr);color:var(--pr)}
.btn-sm{padding:5px 10px;font-size:.77rem}

/* Badges */
.badge{display:inline-flex;align-items:center;justify-content:center;padding:2px 7px;border-radius:99px;font-size:.7rem;font-weight:700}
.badge-ok{background:rgba(0,200,150,.13);color:var(--ok)}
.badge-er{background:rgba(255,71,87,.13);color:var(--er)}
.badge-wa{background:rgba(255,165,2,.13);color:var(--wa)}
.badge-pr{background:rgba(108,99,255,.13);color:var(--pr)}

/* Tables */
.tbl-wrap{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;margin-bottom:13px}
.tbl{width:100%;border-collapse:collapse}
.tbl th{background:var(--bg);padding:9px 12px;text-align:right;font-size:.77rem;font-weight:700;color:var(--mu);border-bottom:1px solid var(--bd)}
.tbl td{padding:9px 12px;font-size:.82rem;border-bottom:1px solid var(--bd);transition:var(--tr)}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(108,99,255,.03)}

/* Forms */
.form-group{margin-bottom:13px}
.form-group label{display:block;font-size:.79rem;font-weight:600;color:var(--mu);margin-bottom:5px}
.form-group input,.form-group select,.form-group textarea{
  width:100%;padding:9px 13px;border:1px solid var(--bd);border-radius:var(--rs);
  background:var(--bg);color:var(--tx);font-size:.88rem;outline:none;transition:var(--tr);
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  border-color:var(--pr);box-shadow:0 0 0 3px var(--pr-g);
}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px}

/* Cards row */
.cards-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:10px;margin-bottom:13px}
.stat-card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:14px;position:relative;overflow:hidden;transition:var(--tr)}
.stat-card:hover{border-color:var(--pr);box-shadow:var(--sh)}
.sc-accent{position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--pr),var(--ac))}
.sc-val{font-size:1.3rem;font-weight:900;color:var(--pr);margin:6px 0 2px}
.sc-lbl{font-size:.74rem;color:var(--mu)}

/* Tabs */
.tabs{display:flex;gap:3px;margin-bottom:13px;background:var(--bg);border-radius:var(--rs);padding:3px;flex-wrap:wrap}
.tab-btn{
  flex:1;padding:8px 10px;border-radius:6px;border:none;background:none;
  cursor:pointer;font-size:.82rem;font-weight:600;color:var(--mu);transition:var(--tr);white-space:nowrap;
}
.tab-btn.active{background:var(--pr);color:#fff;box-shadow:var(--sh)}

/* Search box */
.search-box{position:relative;margin-bottom:12px}
.search-box input{
  width:100%;padding:9px 14px 9px 38px;border:1px solid var(--bd);border-radius:var(--rs);
  background:var(--card);color:var(--tx);font-size:.88rem;outline:none;transition:var(--tr);
}
.search-box input:focus{border-color:var(--pr)}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--mu);font-size:.9rem;pointer-events:none}

/* Notif box */
.notif-box{
  background:var(--card);border:1px solid var(--bd);border-radius:var(--r);
  padding:12px 15px;margin-bottom:13px;min-height:50px;font-size:.85rem;color:var(--mu);
}
.notif-item{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:var(--rs);margin-bottom:5px;font-size:.82rem}
.notif-item:last-child{margin-bottom:0}
.notif-wa{background:rgba(255,165,2,.09);color:var(--wa);border:1px solid rgba(255,165,2,.18)}
.notif-er{background:rgba(255,71,87,.09);color:var(--er);border:1px solid rgba(255,71,87,.18)}
.notif-ok{background:rgba(0,200,150,.09);color:var(--ok);border:1px solid rgba(0,200,150,.18)}
.notif-in{background:rgba(108,99,255,.09);color:var(--pr);border:1px solid rgba(108,99,255,.18)}

/* Modal */
.modal-overlay{
  position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;padding:14px;
  opacity:0;pointer-events:none;transition:opacity var(--tr);
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{
  background:var(--card);border-radius:var(--r);width:100%;max-width:480px;max-height:90vh;
  overflow-y:auto;box-shadow:var(--sh2);
  transform:scale(.96);transition:transform var(--tr);
}
.modal-overlay.open .modal{transform:scale(1)}
.modal-hdr{padding:16px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.modal-hdr h3{font-size:.97rem;font-weight:800}
.modal-close{background:none;border:none;cursor:pointer;color:var(--mu);font-size:1.2rem;transition:color var(--tr)}
.modal-close:hover{color:var(--er)}
.modal-body{padding:18px}
.modal-footer{padding:12px 18px;border-top:1px solid var(--bd);display:flex;gap:7px;justify-content:flex-end}

/* Toast */
.toast-container{position:fixed;top:72px;left:50%;transform:translateX(-50%);z-index:9998;display:flex;flex-direction:column;gap:7px;align-items:center}
.toast{
  background:var(--card);border:1px solid var(--bd);border-radius:var(--rs);
  padding:11px 18px;box-shadow:var(--sh2);font-size:.85rem;font-weight:600;
  min-width:210px;text-align:center;
  animation:toastIn .25s ease,toastOut .25s ease 2.6s forwards;
}
.toast-ok{border-color:var(--ok);color:var(--ok)}
.toast-er{border-color:var(--er);color:var(--er)}
.toast-in{border-color:var(--pr);color:var(--pr)}
.toast-wa{border-color:var(--wa);color:var(--wa)}
@keyframes toastIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0}}

/* Toggle switch */
.tog-wrap{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;background:var(--bg);border-radius:var(--rs);margin-bottom:7px}
.tog-wrap label:first-child{font-size:.85rem;font-weight:600}
.toggle{position:relative;width:42px;height:22px}
.toggle input{opacity:0;width:0;height:0}
.tog-sl{position:absolute;inset:0;background:var(--bd);border-radius:99px;cursor:pointer;transition:var(--tr)}
.tog-sl::before{content:'';position:absolute;width:16px;height:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:var(--tr)}
.toggle input:checked+.tog-sl{background:var(--pr)}
.toggle input:checked+.tog-sl::before{transform:translateX(20px)}

/* Settings tabs */
.stg-tabs{display:flex;gap:1px;border-bottom:2px solid var(--bd);margin-bottom:17px;overflow-x:auto}
.stg-tab{
  padding:10px 16px;border:none;background:none;cursor:pointer;
  font-size:.85rem;font-weight:600;color:var(--mu);transition:var(--tr);
  white-space:nowrap;border-bottom:2px solid transparent;margin-bottom:-2px;
}
.stg-tab.active{color:var(--pr);border-bottom-color:var(--pr)}

/* Color swatches */
.color-options{display:flex;gap:7px;flex-wrap:wrap;margin-top:7px}
.color-swatch{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:var(--tr)}
.color-swatch.active{border-color:var(--tx);transform:scale(1.15)}

/* Virtual keyboard */
.vkb{
  position:fixed;bottom:16px;left:16px;z-index:300;
  background:var(--card);border:1px solid var(--bd);border-radius:var(--r);
  box-shadow:var(--sh2);padding:10px;width:360px;display:none;
}
.vkb.show{display:block}
.vkb-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;cursor:move;user-select:none}
.vkb-title{font-size:.78rem;font-weight:700;color:var(--mu)}
.vkb-row{display:flex;gap:3px;margin-bottom:3px;justify-content:center;flex-wrap:wrap}
.vkb-key{
  min-width:28px;height:34px;padding:0 6px;border:1px solid var(--bd);border-radius:5px;
  background:var(--bg);color:var(--tx);font-size:.8rem;font-weight:600;cursor:pointer;
  transition:var(--tr);display:flex;align-items:center;justify-content:center;white-space:nowrap;
}
.vkb-key:hover{background:var(--pr);color:#fff;border-color:var(--pr)}
.vkb-key.wide{min-width:54px}
.vkb-key.wider{min-width:90px}
.vkb-key.special{background:rgba(108,99,255,.1);color:var(--pr)}
.vkb-key.special:hover{background:var(--pr);color:#fff}
.vkb-lang-sel{display:flex;gap:4px;margin-bottom:6px;justify-content:center}
.vkb-lang-btn{padding:3px 10px;border:1px solid var(--bd);border-radius:5px;background:var(--bg);color:var(--mu);cursor:pointer;font-size:.75rem;font-weight:600;transition:var(--tr)}
.vkb-lang-btn.active{background:var(--pr);color:#fff;border-color:var(--pr)}

/* Tooltip */
[data-tip]{position:relative}
[data-tip]::after{
  content:attr(data-tip);position:absolute;bottom:calc(100% + 5px);left:50%;
  transform:translateX(-50%);background:var(--tx);color:var(--card);
  padding:3px 7px;border-radius:5px;font-size:.7rem;white-space:nowrap;
  opacity:0;pointer-events:none;transition:opacity var(--tr);z-index:999;
}
[data-tip]:hover::after{opacity:1}

/* Confirm popup */
.confirm-overlay{
  position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity var(--tr);
}
.confirm-overlay.open{opacity:1;pointer-events:all}
.confirm-box{
  background:var(--card);border-radius:var(--r);padding:28px 32px;
  text-align:center;max-width:380px;width:90%;box-shadow:var(--sh2);
  transform:scale(.95);transition:transform var(--tr);
}
.confirm-overlay.open .confirm-box{transform:scale(1)}
.confirm-box h3{font-size:1.1rem;font-weight:800;margin-bottom:10px}
.confirm-box p{font-size:.88rem;color:var(--mu);margin-bottom:20px}
.confirm-btns{display:flex;gap:9px;justify-content:center}

/* Responsive */
@media(max-width:700px){
  .sale-layout{flex-direction:column}
  .sale-products-panel,.sale-cart-panel{flex:none;height:50%}
  .sale-divider{display:none}
  .sale-cart-panel{border-right:none;border-top:3px solid var(--bd)}
}
@media print{body *{visibility:hidden}#print-area,#print-area *{visibility:visible}#print-area{position:absolute;top:0;left:0}}

/* About section special */
.about-hero{
  background:linear-gradient(135deg,var(--pr),var(--ac));
  border-radius:var(--r);padding:30px;text-align:center;color:#fff;margin-bottom:14px;
}
.about-hero h1{font-size:2.2rem;font-weight:900;margin-bottom:5px}
.about-hero p{opacity:.85;font-size:1rem}
.about-hero .meta{margin-top:13px;opacity:.75;font-size:.85rem;line-height:1.8}
.about-card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px;margin-bottom:11px;text-align:center}
.about-card h4{margin-bottom:8px;font-size:.95rem}
.about-footer{text-align:center;color:var(--mu);font-size:.78rem;margin-top:14px}

/* Wilaya select */
select option{background:var(--card);color:var(--tx)}
</style>
</head>
<body>

<!-- ================================================================
     LOGIN
     ================================================================ -->
<div id="login-page">
  <div class="lgn-bg"></div>
  <div class="lgn-particles" id="lgn-particles"></div>
  <div class="lgn-ring" style="width:350px;height:350px;top:5%;left:3%;animation-delay:0s"></div>
  <div class="lgn-ring" style="width:550px;height:550px;top:25%;right:-8%;animation-delay:1.2s"></div>
  <div class="lgn-ring" style="width:220px;height:220px;bottom:10%;left:18%;animation-delay:2.4s"></div>

  <div class="lgn-box">
    <div class="lgn-logo">
      <h1>E-Commerce DZ</h1>
      <p id="lgn-sub">نظام نقاط البيع الذكي</p>
    </div>

    <div class="lgn-err" id="lgn-err" data-ar="اسم المستخدم أو كلمة المرور غير صحيحة" data-fr="Identifiant ou mot de passe incorrect">اسم المستخدم أو كلمة المرور غير صحيحة</div>

    <div class="lgn-field">
      <label id="lgn-user-lbl">اسم المستخدم (اختياري)</label>
      <input type="text" id="lgn-user" placeholder="admin" autocomplete="username">
    </div>

    <div class="lgn-field">
      <label id="lgn-pass-lbl">كلمة المرور</label>
      <div class="iw">
        <input type="password" id="lgn-pass" placeholder="••••" autocomplete="current-password">
        <button class="eye-btn" onclick="toggleEye()" id="eye-btn" title="إظهار / إخفاء">
          <svg id="eye-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>

    <label class="lgn-remember">
      <input type="checkbox" id="lgn-remember">
      <span id="lgn-remember-lbl">حفظ بيانات الدخول</span>
    </label>

    <button class="lgn-btn" id="lgn-btn" onclick="doLogin()">دخول</button>
  </div>
</div>

<!-- ================================================================
     MAIN APP
     ================================================================ -->
<div id="app" style="display:none">

  <!-- HEADER -->
  <header class="app-hdr">
    <div class="hdr-r">
      <button class="bti" onclick="toggleSB()" id="menu-btn" data-tip="القائمة الرئيسية">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <button class="bti" onclick="openNotifPanel()" id="back-btn" data-tip="الإشعارات" style="display:none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      </button>
      <button class="bti" onclick="openNotifPanel()" id="notif-btn" data-tip="الإشعارات" style="position:relative">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span class="n-badge" id="notif-count" style="display:none">0</span>
      </button>
    </div>

    <div class="hdr-c">
      <div class="store-hdr-name" id="store-hdr-name">E-Commerce DZ</div>
      <div class="page-title-hdr" id="page-title-hdr" style="display:none"></div>
    </div>

    <div class="hdr-l">
      <div>
        <div class="app-name-glow">E-Commerce DZ</div>
        <div class="hdr-dt">
          <span class="hdr-clock" id="clock">00:00:00</span>
          <span class="hdr-date" id="date-disp"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- SIDEBAR OVERLAY -->
  <div class="sb-overlay" id="sb-overlay" onclick="closeSB()"></div>

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sb-hdr">
      <div class="sb-logo">E-Commerce DZ</div>
      <button class="sb-close" onclick="closeSB()">&#x2715;</button>
    </div>
    <div class="sb-nav">
      <button class="nav-item" onclick="goPage('sale')" data-tip-sb="واجهة البيع" id="nav-sale">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        <span data-key="nav_sale">واجهة البيع</span>
      </button>
      <button class="nav-item" onclick="goPage('inventory')" id="nav-inventory">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
        <span data-key="nav_inventory">ادارة السلع</span>
      </button>
      <button class="nav-item" onclick="goPage('debts')" id="nav-debts">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <span data-key="nav_debts">الدين والتوصيل</span>
      </button>
      <button class="nav-item" onclick="goPage('business')" id="nav-business">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <span data-key="nav_business">ادارة الأعمال</span>
      </button>
      <button class="nav-item" onclick="goPage('users')" id="nav-users">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span data-key="nav_users">ادارة المستخدمين</span>
      </button>
      <button class="nav-item" onclick="goPage('extdebts')" id="nav-extdebts">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        <span data-key="nav_extdebts">الديون الخارجية</span>
      </button>
      <button class="nav-item" onclick="goPage('settings')" id="nav-settings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span data-key="nav_settings">الاعدادات العامة</span>
      </button>
      <hr class="nav-divider">
      <button class="nav-item nav-exit" onclick="doLogout()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span data-key="nav_exit">الخروج</span>
      </button>
    </div>
  </nav>

  <!-- APP BODY -->
  <div class="app-body">

    <!-- ===== SALE PAGE ===== -->
    <div class="page active" id="page-sale">
      <div class="sale-layout" id="sale-layout">
        <!-- Products Panel -->
        <div class="sale-products-panel" id="products-panel">
          <div class="panel-wm">E-Commerce DZ</div>
          <div class="panel-hdr">
            <h3 data-key="ph_products">المنتجات</h3>
          </div>
          <div class="prod-search-bar">
            <input type="text" id="prod-search" placeholder="بحث عن منتج..." oninput="filterProds(this.value)" data-key-ph="search_product">
          </div>
          <div class="products-grid" id="products-grid"></div>
        </div>

        <!-- Draggable Divider -->
        <div class="sale-divider" id="sale-divider"></div>

        <!-- Cart Panel -->
        <div class="sale-cart-panel" id="cart-panel">
          <div class="panel-wm">E-Commerce DZ</div>
          <div class="panel-hdr">
            <h3 data-key="ph_cart">سلة المشتريات</h3>
          </div>
          <div class="cart-items" id="cart-items"></div>

          <div class="cart-totals">
            <div class="totals-row">
              <div class="total-cell">
                <div class="tc-label" data-key="lbl_items">الاصناف</div>
                <div class="tc-value" id="tot-items">0</div>
              </div>
              <div class="total-cell">
                <div class="tc-label" data-key="lbl_qty">العدد</div>
                <div class="tc-value" id="tot-qty">0</div>
              </div>
              <div class="total-cell">
                <div class="tc-label" data-key="lbl_total">المجموع</div>
                <div class="tc-value" id="tot-price">0.00</div>
              </div>
            </div>
          </div>

          <div class="sale-actions">
            <button class="sale-btn btn-pay" onclick="onPay()" data-key="btn_pay">تسديد</button>
            <button class="sale-btn btn-deliver" onclick="openDeliverModal()" data-key="btn_deliver">توصيل</button>
            <button class="sale-btn btn-debt" onclick="openDebtModal()" data-key="btn_debt">دين</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== INVENTORY PAGE ===== -->
    <div class="page" id="page-inventory">
      <div class="pg-hdr">
        <button class="btn-back" onclick="goPage('sale')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          <span data-key="btn_back">رجوع</span>
        </button>
        <h2 data-key="pg_inventory">ادارة السلع</h2>
        <div style="width:80px"></div>
      </div>
      <div class="pg-body" id="inv-body"></div>
    </div>

    <!-- ===== DEBTS & DELIVERY PAGE ===== -->
    <div class="page" id="page-debts">
      <div class="pg-hdr">
        <button class="btn-back" onclick="goPage('sale')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          <span data-key="btn_back">رجوع</span>
        </button>
        <h2 data-key="pg_debts">الدين والتوصيل</h2>
        <div style="width:80px"></div>
      </div>
      <div class="pg-body" id="debts-body"></div>
    </div>

    <!-- ===== BUSINESS PAGE ===== -->
    <div class="page" id="page-business">
      <div class="pg-hdr">
        <button class="btn-back" onclick="goPage('sale')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          <span data-key="btn_back">رجوع</span>
        </button>
        <h2 data-key="pg_business">ادارة الأعمال</h2>
        <div style="width:80px"></div>
      </div>
      <div class="pg-body" id="business-body"></div>
    </div>

    <!-- ===== USERS PAGE ===== -->
    <div class="page" id="page-users">
      <div class="pg-hdr">
        <button class="btn-back" onclick="goPage('sale')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          <span data-key="btn_back">رجوع</span>
        </button>
        <h2 data-key="pg_users">ادارة المستخدمين</h2>
        <div style="width:80px"></div>
      </div>
      <div class="pg-body" id="users-body"></div>
    </div>

    <!-- ===== EXT DEBTS PAGE ===== -->
    <div class="page" id="page-extdebts">
      <div class="pg-hdr">
        <button class="btn-back" onclick="goPage('sale')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          <span data-key="btn_back">رجوع</span>
        </button>
        <h2 data-key="pg_extdebts">الديون الخارجية</h2>
        <div style="width:80px"></div>
      </div>
      <div class="pg-body" id="extdebts-body"></div>
    </div>

    <!-- ===== SETTINGS PAGE ===== -->
    <div class="page" id="page-settings">
      <div class="pg-hdr">
        <button class="btn-back" onclick="goPage('sale')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          <span data-key="btn_back">رجوع</span>
        </button>
        <h2 data-key="pg_settings">الاعدادات العامة</h2>
        <div style="width:80px"></div>
      </div>
      <div class="pg-body" id="settings-body"></div>
    </div>

  </div><!-- end app-body -->
</div><!-- end app -->

<!-- TOAST -->
<div class="toast-container" id="toast-container"></div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <h3 id="confirm-title">تأكيد</h3>
    <p id="confirm-msg"></p>
    <div class="confirm-btns">
      <button class="btn btn-er" id="confirm-yes" onclick="confirmYes()">تأكيد</button>
      <button class="btn btn-out" onclick="closeConfirm()">إلغاء</button>
    </div>
  </div>
</div>

<!-- PAY CONFIRM -->
<div class="confirm-overlay" id="pay-confirm">
  <div class="confirm-box">
    <h3 data-key="pay_confirm_title">تأكيد التسديد</h3>
    <p id="pay-confirm-msg" data-key="pay_confirm_msg">هل تريد تأكيد عملية البيع؟</p>
    <div class="confirm-btns">
      <button class="btn btn-ok" onclick="finalizePay()">تأكيد</button>
      <button class="btn btn-out" onclick="closeModal('pay-confirm')">إغلاق</button>
    </div>
  </div>
</div>

<!-- DELIVER MODAL -->
<div class="modal-overlay" id="deliver-modal">
  <div class="modal">
    <div class="modal-hdr">
      <h3 data-key="deliver_modal_title">معلومات التوصيل</h3>
      <button class="modal-close" onclick="closeModal('deliver-modal')">&#x2715;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_firstname">الاسم</label>
          <input type="text" id="del-fname" placeholder="">
        </div>
        <div class="form-group">
          <label data-key="lbl_lastname">اللقب</label>
          <input type="text" id="del-lname" placeholder="">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_phone">رقم الهاتف</label>
          <input type="tel" id="del-phone" placeholder="0xxxxxxxxx">
        </div>
        <div class="form-group">
          <label data-key="lbl_address">العنوان</label>
          <input type="text" id="del-address" placeholder="">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_wilaya">الولاية (اختياري)</label>
          <select id="del-wilaya"><option value="">-- اختر الولاية --</option></select>
        </div>
        <div class="form-group">
          <label data-key="lbl_company">شركة التوصيل (اختياري)</label>
          <select id="del-company">
            <option value="">-- اختر --</option>
            <option>World Express</option>
            <option>Yalidine</option>
            <option>DHD Livraison</option>
            <option>Kazi Tour</option>
            <option>ZR Express</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_prod_type">نوع المنتج المرسل</label>
          <input type="text" id="del-prod-type" placeholder="">
        </div>
        <div class="form-group">
          <label data-key="lbl_prod_price">سعر المنتج</label>
          <input type="number" id="del-prod-price" placeholder="0" min="0">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-out" onclick="closeModal('deliver-modal')" data-key="btn_cancel">إلغاء</button>
      <button class="btn btn-pr" onclick="saveDelivery()" data-key="btn_save">حفظ</button>
    </div>
  </div>
</div>

<!-- DEBT MODAL -->
<div class="modal-overlay" id="debt-modal">
  <div class="modal">
    <div class="modal-hdr">
      <h3 data-key="debt_modal_title">تسجيل دين</h3>
      <button class="modal-close" onclick="closeModal('debt-modal')">&#x2715;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_firstname">الاسم</label>
          <input type="text" id="dbt-fname" placeholder="">
        </div>
        <div class="form-group">
          <label data-key="lbl_lastname">اللقب</label>
          <input type="text" id="dbt-lname" placeholder="">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_phone">رقم الهاتف</label>
          <input type="tel" id="dbt-phone" placeholder="0xxxxxxxxx">
        </div>
        <div class="form-group">
          <label data-key="lbl_address">العنوان</label>
          <input type="text" id="dbt-address" placeholder="">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="lbl_wilaya">الولاية (اختياري)</label>
          <select id="dbt-wilaya"><option value="">-- اختر الولاية --</option></select>
        </div>
        <div class="form-group">
          <label data-key="lbl_debt_type">نوع الدين</label>
          <input type="text" id="dbt-type" placeholder="">
        </div>
      </div>
      <div class="form-group">
        <label data-key="lbl_debt_amount">قيمة الدين</label>
        <input type="number" id="dbt-amount" placeholder="0" min="0">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-out" onclick="closeModal('debt-modal')" data-key="btn_cancel">إلغاء</button>
      <button class="btn btn-pr" onclick="saveDebt()" data-key="btn_save">حفظ</button>
    </div>
  </div>
</div>

<!-- NOTIF PANEL MODAL -->
<div class="modal-overlay" id="notif-modal">
  <div class="modal">
    <div class="modal-hdr">
      <h3 data-key="notif_title">الاشعارات</h3>
      <button class="modal-close" onclick="closeModal('notif-modal')">&#x2715;</button>
    </div>
    <div class="modal-body" id="notif-list" style="max-height:400px;overflow-y:auto"></div>
    <div class="modal-footer">
      <button class="btn btn-out" onclick="clearNotifs()" data-key="btn_clear_notifs">مسح الكل</button>
      <button class="btn btn-pr" onclick="closeModal('notif-modal')" data-key="btn_close">إغلاق</button>
    </div>
  </div>
</div>

<!-- VIRTUAL KEYBOARD -->
<div class="vkb" id="vkb">
  <div class="vkb-hdr" id="vkb-hdr">
    <span class="vkb-title" data-key="vkb_title">لوحة المفاتيح</span>
    <button onclick="toggleVKB()" style="background:none;border:none;cursor:pointer;color:var(--mu);font-size:1rem">&#x2715;</button>
  </div>
  <div class="vkb-lang-sel">
    <button class="vkb-lang-btn active" id="vkb-lang-ar" onclick="setVKBLang('ar')">AR</button>
    <button class="vkb-lang-btn" id="vkb-lang-fr" onclick="setVKBLang('fr')">FR</button>
    <button class="vkb-lang-btn" id="vkb-lang-num" onclick="setVKBLang('num')">123</button>
    <button class="vkb-lang-btn" id="vkb-lang-sym" onclick="setVKBLang('sym')">!@#</button>
  </div>
  <div id="vkb-layout"></div>
</div>

<!-- VKB Toggle -->
<button id="vkb-toggle-btn" onclick="toggleVKB()" style="position:fixed;bottom:16px;right:16px;z-index:299;width:42px;height:42px;border-radius:50%;border:none;background:var(--pr);color:#fff;cursor:pointer;box-shadow:var(--sh2);font-size:1.1rem;display:none" data-tip="لوحة المفاتيح">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"/></svg>
</button>

<script>
/* ================================================================
   DATABASE
   ================================================================ */
const DB={
  g(k,d=null){try{const v=localStorage.getItem('ecdz_'+k);return v?JSON.parse(v):d}catch{return d}},
  s(k,v){try{localStorage.setItem('ecdz_'+k,JSON.stringify(v))}catch{}},
  r(k){try{localStorage.removeItem('ecdz_'+k)}catch{}}
};

/* ================================================================
   TRANSLATIONS
   ================================================================ */
const T={
  ar:{
    nav_sale:'واجهة البيع',nav_inventory:'ادارة السلع',nav_debts:'الدين والتوصيل',
    nav_business:'ادارة الأعمال',nav_users:'ادارة المستخدمين',
    nav_extdebts:'الديون الخارجية',nav_settings:'الاعدادات العامة',nav_exit:'الخروج',
    btn_back:'رجوع',btn_save:'حفظ',btn_cancel:'إلغاء',btn_close:'إغلاق',
    btn_pay:'تسديد',btn_deliver:'توصيل',btn_debt:'دين',
    btn_add:'اضافة',btn_edit:'تعديل',btn_delete:'حذف',btn_clear_notifs:'مسح الكل',
    ph_products:'المنتجات',ph_cart:'سلة المشتريات',
    lbl_items:'الاصناف',lbl_qty:'العدد',lbl_total:'المجموع',
    lbl_firstname:'الاسم',lbl_lastname:'اللقب',lbl_phone:'رقم الهاتف',
    lbl_address:'العنوان',lbl_wilaya:'الولاية',lbl_company:'شركة التوصيل',
    lbl_prod_type:'نوع المنتج',lbl_prod_price:'سعر المنتج',
    lbl_debt_type:'نوع الدين',lbl_debt_amount:'قيمة الدين',
    pg_inventory:'ادارة السلع',pg_debts:'الدين والتوصيل',pg_business:'ادارة الأعمال',
    pg_users:'ادارة المستخدمين',pg_extdebts:'الديون الخارجية',pg_settings:'الاعدادات العامة',
    pay_confirm_title:'تأكيد التسديد',pay_confirm_msg:'هل تريد تأكيد عملية البيع؟',
    deliver_modal_title:'معلومات التوصيل',debt_modal_title:'تسجيل دين',
    notif_title:'الاشعارات',vkb_title:'لوحة المفاتيح',
    search_product:'بحث عن منتج...',
    lgn_sub:'نظام نقاط البيع الذكي',lgn_user_lbl:'اسم المستخدم (اختياري)',
    lgn_pass_lbl:'كلمة المرور',lgn_remember_lbl:'حفظ بيانات الدخول',lgn_btn:'دخول',
    lgn_err:'اسم المستخدم أو كلمة المرور غير صحيحة',
    toast_saved:'تم الحفظ بنجاح',toast_deleted:'تم الحذف',toast_error:'حدث خطأ',
    toast_cart_added:'تمت الاضافة للسلة',toast_cart_max:'الكمية المتاحة ',
    toast_sold:'تمت عملية البيع بنجاح',toast_oos:'المنتج غير متوفر',
    inv_notif_none:'لا توجد اشعارات',
    tab_all_prod:'كل المنتجات',tab_add_prod:'اضافة منتج',
    tab_debts:'الديون',tab_delivery:'التوصيل',
    lbl_prod_name:'اسم المنتج',lbl_prod_type2:'نوع المنتج',lbl_unit:'الوحدة',
    lbl_buy_price:'سعر الشراء',lbl_sell_price:'سعر البيع',lbl_quantity:'الكمية',
    btn_clear_form:'تفريغ الحقول',btn_save_prod:'حفظ المنتج',
    col_name:'الاسم',col_type:'النوع',col_buy:'سعر الشراء',col_sell:'سعر البيع',
    col_qty:'الكمية',col_status:'الحالة',col_actions:'الاجراءات',
    status_ok:'متوفر',status_low:'منخفض',status_oos:'نفد',
    col_phone:'الهاتف',col_debt:'الدين',col_date:'التاريخ',
    col_paid:'المدفوع',col_remain:'المتبقي',
    btn_pay_full:'تسديد كامل',btn_pay_partial:'تسديد جزئي',
    col_address:'العنوان',col_company:'الشركة',
    tab_day:'اليوم',tab_week:'الاسبوع',tab_month:'الشهر',tab_year:'السنة',tab_products_rep:'تقارير المنتجات',
    lbl_daily_income:'المدخول اليومي',lbl_buy_total:'اجمالي الشراء',
    lbl_sell_total:'اجمالي البيع',lbl_profit:'الفائدة',lbl_items_sold:'المنتجات المباعة',
    lbl_total_debts:'اجمالي الديون',lbl_debtors:'المدينون',
    lbl_deliveries:'التوصيلات',lbl_delivery_total:'مبالغ التوصيل',
    btn_cancel_sale:'إلغاء البيع',btn_close_day:'اقفال اليوم',
    col_invoice:'الفاتورة',col_products:'المنتجات',col_profit:'الفائدة',col_time:'الوقت',col_type:'النوع',
    top_selling:'الأكثر مبيعا',slow_moving:'الراكدة',low_stock:'المخزون المنخفض',
    role_admin:'مدير',role_manager:'مدير مساعد',role_seller:'بائع',
    btn_add_user:'اضافة مستخدم',lbl_username:'اسم المستخدم',lbl_password:'كلمة المرور',lbl_role:'الصلاحية',lbl_fullname:'الاسم الكامل',
    btn_add_extdebt:'اضافة دين خارجي',lbl_ext_name:'الاسم',lbl_ext_phone:'الهاتف',
    lbl_ext_amount:'قيمة الدين',lbl_ext_note:'ملاحظة',
    stg_program:'البرنامج',stg_store:'المتجر',stg_notifs:'الاشعارات',stg_system:'النظام',stg_about:'حول',
    lbl_date_format:'صيغة التاريخ',lbl_currency:'رمز العملة',lbl_lang:'لغة البرنامج',
    lbl_font_size:'حجم الخط',lbl_theme:'المظهر',lbl_color:'لون التطبيق',
    lbl_sound:'اعدادات الصوت',lbl_sound_enable:'تفعيل الاصوات',
    lbl_store_logo:'شعار المتجر',lbl_store_name:'اسم المتجر',lbl_store_phone:'رقم الهاتف',
    lbl_store_addr:'العنوان',lbl_welcome_msg:'رسالة الترحيب',
    lbl_notif_stock:'اشعار المخزون المنخفض',lbl_notif_debt:'اشعار الديون المتأخرة',
    lbl_notif_login:'اشعار دخول المستخدم',
    lbl_auto_backup:'نسخ احتياطي تلقائي',btn_export:'تصدير النسخة',
    lbl_partial_clear:'مسح جزئي للبيانات',lbl_full_clear:'مسح كلي',
    lbl_partial_clear_desc:'يمسح: المبيعات، الديون، سجل العمليات',
    lbl_full_clear_desc:'يمسح كل شيء بما فيه المنتجات والمستخدمين',
    btn_partial_clear:'مسح جزئي',btn_full_clear:'مسح كلي',
    about_title:'نظام نقاط البيع الذكي',about_version:'الاصدار: v3.0.0',about_year:'تاريخ الاصدار: 2026',
    about_license:'حالة الترخيص',about_active:'البرنامج مفعل',
    about_dev:'المطور',about_company:'بوس ديزاد | ب.حمزة',about_contact:'واتساب: 0770044850',
    about_rights:'2026 بوس ديزاد - جميع الحقوق محفوظة',
    partial_pay_prompt:'أدخل المبلغ المدفوع:',
    confirm_delete_prod:'هل تريد حذف هذا المنتج؟',
    confirm_delete_debt:'هل تريد حذف هذا الدين؟',
    confirm_delete_delivery:'هل تريد حذف هذا التوصيل؟',
    confirm_close_day:'تأكيد اقفال اليوم؟ سيتم مسح مصاريف اليوم.',
    confirm_cancel_sale:'هل تريد إلغاء هذا البيع؟',
    confirm_partial_clear:'تأكيد المسح الجزئي؟',
    confirm_full_clear:'تحذير: المسح الكلي! أدخل CONFIRM للتأكيد',
    prod_exists:'المنتج موجود مسبقا',prod_required:'يرجى ملء الحقول المطلوبة',
    prod_sell_low:'سعر البيع أقل من سعر الشراء',
    unit_pc:'قطعة',unit_kg:'كيلو',unit_l:'لتر',unit_box:'علبة',unit_dz:'دستة',unit_item:'حبة',
  },
  fr:{
    nav_sale:'Interface de vente',nav_inventory:'Gestion des articles',nav_debts:'Dettes et livraison',
    nav_business:'Gestion des affaires',nav_users:'Gestion des utilisateurs',
    nav_extdebts:'Dettes externes',nav_settings:'Paramètres généraux',nav_exit:'Quitter',
    btn_back:'Retour',btn_save:'Enregistrer',btn_cancel:'Annuler',btn_close:'Fermer',
    btn_pay:'Payer',btn_deliver:'Livraison',btn_debt:'Dette',
    btn_add:'Ajouter',btn_edit:'Modifier',btn_delete:'Supprimer',btn_clear_notifs:'Effacer tout',
    ph_products:'Produits',ph_cart:'Panier',
    lbl_items:'Articles',lbl_qty:'Quantité',lbl_total:'Total',
    lbl_firstname:'Prénom',lbl_lastname:'Nom',lbl_phone:'Téléphone',
    lbl_address:'Adresse',lbl_wilaya:'Wilaya',lbl_company:'Société de livraison',
    lbl_prod_type:'Type de produit',lbl_prod_price:'Prix du produit',
    lbl_debt_type:'Type de dette',lbl_debt_amount:'Montant de la dette',
    pg_inventory:'Gestion des articles',pg_debts:'Dettes et livraison',pg_business:'Gestion des affaires',
    pg_users:'Gestion des utilisateurs',pg_extdebts:'Dettes externes',pg_settings:'Paramètres généraux',
    pay_confirm_title:'Confirmer le paiement',pay_confirm_msg:'Confirmer la vente?',
    deliver_modal_title:'Informations de livraison',debt_modal_title:'Enregistrer une dette',
    notif_title:'Notifications',vkb_title:'Clavier virtuel',
    search_product:'Rechercher un article...',
    lgn_sub:'Système de point de vente intelligent',lgn_user_lbl:'Nom d\'utilisateur (optionnel)',
    lgn_pass_lbl:'Mot de passe',lgn_remember_lbl:'Mémoriser les identifiants',lgn_btn:'Connexion',
    lgn_err:'Identifiant ou mot de passe incorrect',
    toast_saved:'Sauvegardé avec succès',toast_deleted:'Supprimé',toast_error:'Erreur',
    toast_cart_added:'Ajouté au panier',toast_cart_max:'Quantité disponible ',
    toast_sold:'Vente effectuée avec succès',toast_oos:'Produit non disponible',
    inv_notif_none:'Pas de notifications',
    tab_all_prod:'Tous les articles',tab_add_prod:'Ajouter un article',
    tab_debts:'Dettes',tab_delivery:'Livraison',
    lbl_prod_name:'Nom du produit',lbl_prod_type2:'Type de produit',lbl_unit:'Unité',
    lbl_buy_price:'Prix d\'achat',lbl_sell_price:'Prix de vente',lbl_quantity:'Quantité',
    btn_clear_form:'Effacer',btn_save_prod:'Enregistrer',
    col_name:'Nom',col_type:'Type',col_buy:'Prix achat',col_sell:'Prix vente',
    col_qty:'Qté',col_status:'Statut',col_actions:'Actions',
    status_ok:'Disponible',status_low:'Bas',status_oos:'Épuisé',
    col_phone:'Téléphone',col_debt:'Dette',col_date:'Date',
    col_paid:'Payé',col_remain:'Reste',
    btn_pay_full:'Payer tout',btn_pay_partial:'Paiement partiel',
    col_address:'Adresse',col_company:'Société',
    tab_day:'Aujourd\'hui',tab_week:'Semaine',tab_month:'Mois',tab_year:'Année',tab_products_rep:'Rapports produits',
    lbl_daily_income:'Revenus journaliers',lbl_buy_total:'Total achats',
    lbl_sell_total:'Total ventes',lbl_profit:'Bénéfice',lbl_items_sold:'Articles vendus',
    lbl_total_debts:'Total dettes',lbl_debtors:'Débiteurs',
    lbl_deliveries:'Livraisons',lbl_delivery_total:'Montants en cours',
    btn_cancel_sale:'Annuler vente',btn_close_day:'Clôture du jour',
    col_invoice:'Facture',col_products:'Produits',col_profit:'Bénéfice',col_time:'Heure',col_type:'Type',
    top_selling:'Les plus vendus',slow_moving:'Peu vendus',low_stock:'Stock bas',
    role_admin:'Administrateur',role_manager:'Directeur adjoint',role_seller:'Vendeur',
    btn_add_user:'Ajouter utilisateur',lbl_username:'Nom d\'utilisateur',lbl_password:'Mot de passe',lbl_role:'Rôle',lbl_fullname:'Nom complet',
    btn_add_extdebt:'Ajouter dette externe',lbl_ext_name:'Nom',lbl_ext_phone:'Téléphone',
    lbl_ext_amount:'Montant',lbl_ext_note:'Note',
    stg_program:'Programme',stg_store:'Boutique',stg_notifs:'Notifications',stg_system:'Système',stg_about:'À propos',
    lbl_date_format:'Format de date',lbl_currency:'Devise',lbl_lang:'Langue',
    lbl_font_size:'Taille de police',lbl_theme:'Thème',lbl_color:'Couleur',
    lbl_sound:'Paramètres sonores',lbl_sound_enable:'Activer les sons',
    lbl_store_logo:'Logo boutique',lbl_store_name:'Nom de boutique',lbl_store_phone:'Téléphone',
    lbl_store_addr:'Adresse',lbl_welcome_msg:'Message de bienvenue',
    lbl_notif_stock:'Notification stock bas',lbl_notif_debt:'Notification dettes tardives',
    lbl_notif_login:'Notification connexion utilisateur',
    lbl_auto_backup:'Sauvegarde automatique',btn_export:'Exporter',
    lbl_partial_clear:'Suppression partielle',lbl_full_clear:'Suppression totale',
    lbl_partial_clear_desc:'Supprime: ventes, dettes, historique',
    lbl_full_clear_desc:'Supprime tout: produits, utilisateurs, données',
    btn_partial_clear:'Suppression partielle',btn_full_clear:'Suppression totale',
    about_title:'Système de point de vente intelligent',about_version:'Version: v3.0.0',about_year:'Date: 2026',
    about_license:'Statut de licence',about_active:'Programme activé',
    about_dev:'Développeur',about_company:'Boss Dizad | B.Hamza',about_contact:'WhatsApp: 0770044850',
    about_rights:'2026 Boss Dizad - Tous droits réservés',
    partial_pay_prompt:'Entrez le montant payé:',
    confirm_delete_prod:'Supprimer ce produit?',
    confirm_delete_debt:'Supprimer cette dette?',
    confirm_delete_delivery:'Supprimer cette livraison?',
    confirm_close_day:'Confirmer la clôture du jour?',
    confirm_cancel_sale:'Annuler cette vente?',
    confirm_partial_clear:'Confirmer la suppression partielle?',
    confirm_full_clear:'ATTENTION: Suppression totale! Entrez CONFIRM',
    prod_exists:'Produit déjà existant',prod_required:'Veuillez remplir les champs requis',
    prod_sell_low:'Prix de vente inférieur au prix d\'achat',
    unit_pc:'Pièce',unit_kg:'Kilo',unit_l:'Litre',unit_box:'Boîte',unit_dz:'Douzaine',unit_item:'Unité',
  }
};

/* ================================================================
   STATE
   ================================================================ */
const State={
  cart:[],
  currentPage:'sale',
  lang:DB.g('lang','ar'),
  currency:DB.g('currency','دج'),
  invoiceCounter:DB.g('invoice_counter',1),
  settings:DB.g('settings',{
    storeName:'E-Commerce DZ',phone:'',address:'',welcomeMsg:'شكرا لتسوقكم معنا',
    currency:'دج',dateFormat:'dmy',lang:'ar',theme:'light',color:'default',
    fontSize:15,soundEnabled:true,notifStock:true,notifDebt:true,notifLogin:true,autoBackup:false
  }),
  users:DB.g('users',[{id:1,username:'admin',password:'1234',role:'admin',name:'المدير'}]),
  currentUser:null,
  products:DB.g('products',[]),
  sales:DB.g('sales',[]),
  todaySales:DB.g('today_sales',[]),
  internalDebts:DB.g('internal_debts',[]),
  deliveries:DB.g('deliveries',[]),
  externalDebts:DB.g('external_debts',[]),
  notifications:DB.g('notifications',[]),
};

function t(k){return (T[State.lang]||T.ar)[k]||k}
function saveState(){
  DB.s('products',State.products);DB.s('sales',State.sales);
  DB.s('today_sales',State.todaySales);DB.s('internal_debts',State.internalDebts);
  DB.s('deliveries',State.deliveries);DB.s('external_debts',State.externalDebts);
  DB.s('notifications',State.notifications);DB.s('settings',State.settings);
  DB.s('users',State.users);DB.s('invoice_counter',State.invoiceCounter);
}

/* ================================================================
   SOUNDS
   ================================================================ */
let sndCtx=null;
function initSnd(){try{sndCtx=new(window.AudioContext||window.webkitAudioContext)()}catch{}}
function beep(freq=800,dur=0.1,type='sine'){
  if(!State.settings.soundEnabled||!sndCtx)return;
  try{
    const o=sndCtx.createOscillator();const g=sndCtx.createGain();
    o.connect(g);g.connect(sndCtx.destination);
    o.frequency.value=freq;o.type=type;
    g.gain.setValueAtTime(0.25,sndCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,sndCtx.currentTime+dur);
    o.start(sndCtx.currentTime);o.stop(sndCtx.currentTime+dur);
  }catch{}
}
const Snd={
  click(){beep(600,0.07)},
  add(){beep(880,0.12)},
  ok(){beep(1000,0.15);setTimeout(()=>beep(1200,0.15),130)},
  err(){beep(220,0.25,'square')},
  notif(){beep(700,0.1);setTimeout(()=>beep(900,0.12),90)}
};

/* ================================================================
   TOAST
   ================================================================ */
function toast(msg,type='ok',dur=3000){
  const c=document.getElementById('toast-container');
  const el=document.createElement('div');
  el.className=`toast toast-${type}`;el.textContent=msg;
  c.appendChild(el);setTimeout(()=>el.remove(),dur);
}

/* ================================================================
   CONFIRM DIALOG
   ================================================================ */
let _confirmCb=null;
function showConfirm(title,msg,cb){
  document.getElementById('confirm-title').textContent=title;
  document.getElementById('confirm-msg').textContent=msg;
  _confirmCb=cb;
  document.getElementById('confirm-overlay').classList.add('open');
}
function confirmYes(){closeConfirm();if(_confirmCb)_confirmCb()}
function closeConfirm(){document.getElementById('confirm-overlay').classList.remove('open');_confirmCb=null}

/* ================================================================
   MODAL
   ================================================================ */
function openModal(id){document.getElementById(id).classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}

/* ================================================================
   WILAYA LIST
   ================================================================ */
const WILAYAS=['أدرار','الشلف','الأغواط','أم البواقي','باتنة','بجاية','بسكرة','بشار','البليدة','البويرة','تمنراست','تبسة','تلمسان','تيارت','تيزي وزو','الجزائر','الجلفة','جيجل','سطيف','سعيدة','سكيكدة','سيدي بلعباس','عنابة','قالمة','قسنطينة','المدية','مستغانم','المسيلة','معسكر','ورقلة','وهران','البيض','إليزي','برج بوعريريج','بومرداس','الطارف','تندوف','تيسمسيلت','الوادي','خنشلة','سوق أهراس','تيبازة','ميلة','عين الدفلى','النعامة','عين تموشنت','غرداية','غليزان','المغير','المنيعة','أولاد جلال','برج باجي مختار','بني عباس','تيميمون','توقرت','دلفا','عين صالح','عين قزام'];
function fillWilayas(sel){
  WILAYAS.forEach((w,i)=>{
    const o=document.createElement('option');o.value=w;o.textContent=`${i+1}. ${w}`;sel.appendChild(o);
  });
}

/* ================================================================
   CLOCK
   ================================================================ */
function startClock(){
  const update=()=>{
    const n=new Date();
    const p=v=>String(v).padStart(2,'0');
    const clockEl=document.getElementById('clock');
    if(clockEl)clockEl.textContent=`${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
    const days_ar=['الاحد','الاثنين','الثلاثاء','الاربعاء','الخميس','الجمعة','السبت'];
    const days_fr=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
    const months_ar=['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
    const months_fr=['Jan','Fév','Mar','Avr','Mai','Juin','Juil','Aoû','Sep','Oct','Nov','Déc'];
    const dd=document.getElementById('date-disp');
    if(dd){
      if(State.lang==='fr'){
        dd.textContent=`${days_fr[n.getDay()]} ${n.getDate()} ${months_fr[n.getMonth()]} ${n.getFullYear()}`;
      } else {
        dd.textContent=`${days_ar[n.getDay()]} ${n.getDate()} ${months_ar[n.getMonth()]} ${n.getFullYear()}`;
      }
    }
  };
  update();setInterval(update,1000);
}

/* ================================================================
   LOGIN
   ================================================================ */
function initLogin(){
  const saved=DB.g('saved_creds');
  if(saved){
    document.getElementById('lgn-user').value=saved.u||'';
    document.getElementById('lgn-pass').value=saved.p||'';
    document.getElementById('lgn-remember').checked=true;
  }
  // Particles
  const pc=document.getElementById('lgn-particles');
  for(let i=0;i<18;i++){
    const p=document.createElement('div');p.className='particle';
    const s=Math.random()*6+2;
    p.style.cssText=`width:${s}px;height:${s}px;left:${Math.random()*100}%;background:${Math.random()>.5?'#6c63ff':'#00d4ff'};animation-duration:${Math.random()*10+8}s;animation-delay:${Math.random()*8}s`;
    pc.appendChild(p);
  }
  document.getElementById('lgn-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
}

let eyeVisible=false;
function toggleEye(){
  eyeVisible=!eyeVisible;
  document.getElementById('lgn-pass').type=eyeVisible?'text':'password';
  const icon=document.getElementById('eye-icon');
  icon.innerHTML=eyeVisible
    ?'<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'
    :'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
}

function doLogin(){
  Snd.click();
  const user=document.getElementById('lgn-user').value.trim()||'admin';
  const pass=document.getElementById('lgn-pass').value;
  const u=State.users.find(x=>x.username===user&&x.password===pass);
  if(u){
    State.currentUser=u;
    if(document.getElementById('lgn-remember').checked){
      DB.s('saved_creds',{u:user,p:pass});
    } else {
      DB.r('saved_creds');
    }
    addNotif(t('nav_sale')+' - '+u.name,'in');
    showApp();
    Snd.ok();
  } else {
    document.getElementById('lgn-err').style.display='block';
    Snd.err();
    setTimeout(()=>document.getElementById('lgn-err').style.display='none',3000);
  }
}

function doLogout(){
  Snd.click();closeSB();
  document.getElementById('login-page').style.display='flex';
  document.getElementById('app').style.display='none';
  State.currentUser=null;
  document.getElementById('lgn-pass').value='';
}

/* ================================================================
   SHOW APP
   ================================================================ */
function showApp(){
  document.getElementById('login-page').style.display='none';
  document.getElementById('app').style.display='flex';
  applySettings();
  updateStoreName();
  renderSalePage();
  checkNotifs();
  document.getElementById('vkb-toggle-btn').style.display='flex';
}

/* ================================================================
   SIDEBAR
   ================================================================ */
function toggleSB(){Snd.click();document.getElementById('sidebar').classList.toggle('open');document.getElementById('sb-overlay').classList.toggle('show')}
function closeSB(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sb-overlay').classList.remove('show')}

/* ================================================================
   PAGE NAVIGATION
   ================================================================ */
const PAGE_TITLES={
  sale:'nav_sale',inventory:'pg_inventory',debts:'pg_debts',
  business:'pg_business',users:'pg_users',extdebts:'pg_extdebts',settings:'pg_settings'
};

function goPage(page){
  Snd.click();closeSB();
  // Save cart
  DB.s('cart_saved',State.cart);
  // Hide all
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const pg=document.getElementById('page-'+page);
  if(pg)pg.classList.add('active');
  State.currentPage=page;

  // Header
  const menuBtn=document.getElementById('menu-btn');
  const backBtn=document.getElementById('back-btn');
  const titleHdr=document.getElementById('page-title-hdr');
  const storeHdr=document.getElementById('store-hdr-name');

  // Update nav active
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('nav-active'));
  const navEl=document.getElementById('nav-'+page);
  if(navEl)navEl.classList.add('nav-active');

  if(page==='sale'){
    menuBtn.style.display='flex';backBtn.style.display='none';
    titleHdr.style.display='none';storeHdr.style.display='block';
    renderSalePage();
  } else {
    menuBtn.style.display='none';backBtn.style.display='none';
    titleHdr.style.display='block';storeHdr.style.display='none';
    titleHdr.textContent=t(PAGE_TITLES[page]||'');
    // Render page
    if(page==='inventory')renderInventory();
    else if(page==='debts')renderDebts();
    else if(page==='business')renderBusiness();
    else if(page==='users')renderUsers();
    else if(page==='extdebts')renderExtDebts();
    else if(page==='settings')renderSettings();
  }
  // Reset divider on return to sale
  if(page==='sale'){
    const pp=document.getElementById('products-panel');
    const cp=document.getElementById('cart-panel');
    if(pp&&cp){pp.style.flex='1';cp.style.flex='1';}
  }
}

/* ================================================================
   SALE PAGE
   ================================================================ */
function renderSalePage(){
  // Restore cart from saved
  const saved=DB.g('cart_saved',[]);
  if(saved.length>0&&State.cart.length===0)State.cart=saved;
  renderProducts();renderCart();
}

function renderProducts(filter=''){
  const grid=document.getElementById('products-grid');if(!grid)return;
  grid.innerHTML='';
  let prods=State.products;
  if(filter)prods=prods.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())||(p.type||'').toLowerCase().includes(filter.toLowerCase()));
  if(!prods.length){
    grid.innerHTML=`<div class="no-products">${t('tab_all_prod')}: 0</div>`;return;
  }
  prods.forEach(p=>{
    const div=document.createElement('div');
    div.className='product-card'+(p.qty<=0?' oos':'');
    div.innerHTML=`<div class="pc-name">${p.name}</div><div class="pc-price">${p.sellPrice} ${State.settings.currency}</div><div class="pc-stock ${p.qty<=0?'zero':p.qty<=5?'low':''}">${p.qty<=0?t('status_oos'):p.qty<=5?`${t('status_low')}: ${p.qty}`:p.qty}</div>`;
    if(p.qty>0)div.onclick=()=>addToCart(p);
    grid.appendChild(div);
  });
}

function filterProds(v){renderProducts(v)}

function addToCart(prod){
  Snd.add();
  const ex=State.cart.find(i=>i.id===prod.id);
  if(ex){
    if(ex.qty>=prod.qty){toast(t('toast_cart_max')+prod.qty,'wa');Snd.err();return;}
    ex.qty++;ex.total=ex.qty*ex.price;
  } else {
    State.cart.push({id:prod.id,name:prod.name,price:prod.sellPrice,qty:1,total:prod.sellPrice,buyPrice:prod.buyPrice||0});
  }
  DB.s('cart_saved',State.cart);renderCart();toast(t('toast_cart_added')+': '+prod.name,'ok',1500);
}

function renderCart(){
  const c=document.getElementById('cart-items');if(!c)return;
  if(!State.cart.length){
    c.innerHTML=`<div class="cart-empty-msg"><div style="font-size:2.5rem;margin-bottom:8px">[ ]</div><div>${t('ph_cart')}</div></div>`;
    updateTotals();return;
  }
  c.innerHTML='';
  State.cart.forEach((item,idx)=>{
    const row=document.createElement('div');row.className='cart-item';
    row.innerHTML=`<span class="ci-name">${item.name}</span>
<div class="qty-ctrl">
  <button class="qty-btn" onclick="chQty(${idx},-1)">-</button>
  <input class="qty-inp" type="number" value="${item.qty}" min="1" onchange="setQty(${idx},this.value)">
  <button class="qty-btn" onclick="chQty(${idx},1)">+</button>
</div>
<input class="price-inp" type="number" value="${item.price}" onchange="setPrice(${idx},this.value)">
<span class="ci-total">${item.total.toFixed(2)} ${State.settings.currency}</span>
<button class="del-btn" onclick="removeCart(${idx})">X</button>`;
    c.appendChild(row);
  });
  updateTotals();
}

function chQty(idx,d){
  const item=State.cart[idx];const prod=State.products.find(p=>p.id===item.id);
  const nq=item.qty+d;
  if(nq<1){removeCart(idx);return;}
  if(prod&&nq>prod.qty){toast(t('toast_cart_max')+prod.qty,'wa');return;}
  item.qty=nq;item.total=nq*item.price;DB.s('cart_saved',State.cart);renderCart();
}
function setQty(idx,v){
  const q=Math.max(1,parseInt(v)||1);State.cart[idx].qty=q;State.cart[idx].total=q*State.cart[idx].price;
  DB.s('cart_saved',State.cart);renderCart();
}
function setPrice(idx,v){
  const p=parseFloat(v)||0;State.cart[idx].price=p;State.cart[idx].total=State.cart[idx].qty*p;
  DB.s('cart_saved',State.cart);renderCart();
}
function removeCart(idx){Snd.click();State.cart.splice(idx,1);DB.s('cart_saved',State.cart);renderCart();}

function updateTotals(){
  const items=State.cart.length;
  const qty=State.cart.reduce((s,i)=>s+i.qty,0);
  const total=State.cart.reduce((s,i)=>s+i.total,0);
  const sel=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v};
  sel('tot-items',items);sel('tot-qty',qty);sel('tot-price',total.toFixed(2)+' '+State.settings.currency);
}

// PAY
function onPay(){
  if(!State.cart.length){toast(t('ph_cart')+': 0','wa');return;}
  Snd.click();openModal('pay-confirm');
}

function finalizePay(){
  closeModal('pay-confirm');
  const total=State.cart.reduce((s,i)=>s+i.total,0);
  const buyTotal=State.cart.reduce((s,i)=>s+(i.buyPrice*i.qty),0);
  const profit=total-buyTotal;
  const inv='#'+String(State.invoiceCounter).padStart(3,'0');
  const sale={
    id:Date.now(),invoiceNum:inv,items:[...State.cart],
    total,buyTotal,profit,date:new Date().toISOString(),
    type:'cash',user:State.currentUser?.name||'admin'
  };
  State.sales.push(sale);State.todaySales.push(sale);
  State.cart.forEach(item=>{
    const p=State.products.find(x=>x.id===item.id);
    if(p){p.qty-=item.qty;if(p.qty<=5)addNotif(t('lbl_notif_stock')+': '+p.name,'wa');}
  });
  State.invoiceCounter++;State.cart=[];
  DB.s('cart_saved',[]);saveState();
  renderCart();renderProducts();
  toast(t('toast_sold'),'ok');Snd.ok();
}

// DELIVERY MODAL
function openDeliverModal(){
  Snd.click();
  fillWilayas(document.getElementById('del-wilaya'));
  openModal('deliver-modal');
}
function saveDelivery(){
  const fname=document.getElementById('del-fname').value.trim();
  const lname=document.getElementById('del-lname').value.trim();
  const phone=document.getElementById('del-phone').value.trim();
  const address=document.getElementById('del-address').value.trim();
  const wilaya=document.getElementById('del-wilaya').value;
  const company=document.getElementById('del-company').value;
  const prodType=document.getElementById('del-prod-type').value.trim();
  const prodPrice=parseFloat(document.getElementById('del-prod-price').value)||0;
  const cartTotal=State.cart.reduce((s,i)=>s+i.total,0);
  const inv='#'+String(State.invoiceCounter).padStart(3,'0');
  const delivery={
    id:Date.now(),invoiceNum:inv,
    name:(fname+' '+lname).trim()||'-',phone:phone||'-',address:address||'-',
    wilaya,company,prodType,prodPrice,
    items:[...State.cart],cartTotal,
    date:new Date().toISOString(),status:'pending'
  };
  State.deliveries.push(delivery);
  // Clear cart items from stock
  State.cart.forEach(item=>{
    const p=State.products.find(x=>x.id===item.id);
    if(p)p.qty-=item.qty;
  });
  State.invoiceCounter++;State.cart=[];DB.s('cart_saved',[]);saveState();
  closeModal('deliver-modal');
  renderCart();renderProducts();
  // Clear form
  ['del-fname','del-lname','del-phone','del-address','del-prod-type','del-prod-price'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('del-wilaya').innerHTML='<option value="">-- '+t('lbl_wilaya')+' --</option>';
  document.getElementById('del-company').value='';
  toast(t('btn_deliver'),'in');Snd.ok();
}

// DEBT MODAL
function openDebtModal(){
  Snd.click();
  fillWilayas(document.getElementById('dbt-wilaya'));
  openModal('debt-modal');
}
function saveDebt(){
  const fname=document.getElementById('dbt-fname').value.trim();
  const lname=document.getElementById('dbt-lname').value.trim();
  const phone=document.getElementById('dbt-phone').value.trim();
  const address=document.getElementById('dbt-address').value.trim();
  const wilaya=document.getElementById('dbt-wilaya').value;
  const dtype=document.getElementById('dbt-type').value.trim();
  const amount=parseFloat(document.getElementById('dbt-amount').value)||0;
  const cartTotal=State.cart.reduce((s,i)=>s+i.total,0);
  const inv='#'+String(State.invoiceCounter).padStart(3,'0');
  const debt={
    id:Date.now(),invoiceNum:inv,
    name:(fname+' '+lname).trim()||'-',phone:phone||'-',address:address||'-',
    wilaya,debtType:dtype,amount:amount||cartTotal,paid:0,remaining:amount||cartTotal,
    items:[...State.cart],cartTotal,
    date:new Date().toISOString()
  };
  State.internalDebts.push(debt);
  // Reduce stock
  State.cart.forEach(item=>{
    const p=State.products.find(x=>x.id===item.id);
    if(p)p.qty-=item.qty;
  });
  State.invoiceCounter++;State.cart=[];DB.s('cart_saved',[]);saveState();
  closeModal('debt-modal');
  renderCart();renderProducts();
  ['dbt-fname','dbt-lname','dbt-phone','dbt-address','dbt-type','dbt-amount'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('dbt-wilaya').innerHTML='<option value="">-- '+t('lbl_wilaya')+' --</option>';
  toast(t('btn_debt'),'in');Snd.ok();
}

/* ================================================================
   DIVIDER DRAG
   ================================================================ */
function initDivider(){
  const divider=document.getElementById('sale-divider');
  const layout=document.getElementById('sale-layout');
  const pp=document.getElementById('products-panel');
  const cp=document.getElementById('cart-panel');
  if(!divider||!pp||!cp)return;
  let dragging=false,startX=0,startPW=0,startCW=0;
  divider.addEventListener('mousedown',e=>{
    dragging=true;startX=e.clientX;
    startPW=pp.getBoundingClientRect().width;
    startCW=cp.getBoundingClientRect().width;
    divider.classList.add('dragging');
    document.body.style.cursor='col-resize';
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const dx=e.clientX-startX;
    // RTL: reversed
    const dir=document.documentElement.dir==='rtl'?-1:1;
    const total=layout.getBoundingClientRect().width-6;
    let nw=Math.max(100,Math.min(total-100,startPW+(dx*dir)));
    pp.style.flex='none';pp.style.width=nw+'px';
    cp.style.flex='1';cp.style.width='';
  });
  document.addEventListener('mouseup',()=>{
    if(!dragging)return;dragging=false;
    divider.classList.remove('dragging');document.body.style.cursor='';
  });
}

/* ================================================================
   INVENTORY PAGE
   ================================================================ */
function renderInventory(){
  const body=document.getElementById('inv-body');if(!body)return;
  // Stock notifications
  const low=State.products.filter(p=>p.qty>0&&p.qty<=5);
  const zero=State.products.filter(p=>p.qty<=0);
  let notifHTML='<div class="notif-box">';
  if(!low.length&&!zero.length){notifHTML+=`<span style="color:var(--mu)">${t('inv_notif_none')}</span>`;}
  else{
    zero.forEach(p=>{notifHTML+=`<div class="notif-item notif-er">${p.name}: ${t('status_oos')}</div>`;});
    low.forEach(p=>{notifHTML+=`<div class="notif-item notif-wa">${p.name}: ${t('status_low')} (${p.qty})</div>`;});
  }
  notifHTML+='</div>';

  body.innerHTML=notifHTML+`
<div class="tabs">
  <button class="tab-btn active" onclick="invTab('all',this)">${t('tab_all_prod')}</button>
  <button class="tab-btn" onclick="invTab('add',this)">${t('tab_add_prod')}</button>
</div>
<div id="inv-tab-all">
  <div class="search-box">
    <span class="search-icon">S</span>
    <input type="text" placeholder="${t('search_product')}" oninput="invSearch(this.value)">
  </div>
  <div class="tbl-wrap"><table class="tbl" id="inv-tbl">
    <thead><tr>
      <th>#</th><th>${t('col_name')}</th><th>${t('col_type')}</th>
      <th>${t('col_buy')}</th><th>${t('col_sell')}</th><th>${t('col_qty')}</th>
      <th>${t('col_status')}</th><th>${t('col_actions')}</th>
    </tr></thead>
    <tbody id="inv-tbody"></tbody>
  </table></div>
</div>
<div id="inv-tab-add" style="display:none">
  <div class="notif-box" id="inv-add-notif" style="min-height:40px;margin-bottom:10px"></div>
  <div style="background:var(--card);border-radius:var(--r);padding:18px;border:1px solid var(--bd)">
    <div class="form-row">
      <div class="form-group"><label>${t('lbl_prod_name')} *</label><input type="text" id="p-name" placeholder="${t('lbl_prod_name')}"></div>
      <div class="form-group"><label>${t('lbl_prod_type2')}</label><input type="text" id="p-type" placeholder="${t('lbl_prod_type2')}"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>${t('lbl_unit')}</label>
        <select id="p-unit"><option value="">--</option>
          <option>${t('unit_pc')}</option><option>${t('unit_kg')}</option><option>${t('unit_l')}</option>
          <option>${t('unit_box')}</option><option>${t('unit_dz')}</option><option>${t('unit_item')}</option>
        </select>
      </div>
      <div class="form-group"><label>${t('lbl_buy_price')} *</label><input type="number" id="p-buy" placeholder="0" min="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>${t('lbl_sell_price')} *</label><input type="number" id="p-sell" placeholder="0" min="0"></div>
      <div class="form-group"><label>${t('lbl_quantity')} *</label><input type="number" id="p-qty" placeholder="0" min="0"></div>
    </div>
    <div style="display:flex;gap:9px;margin-top:6px">
      <button class="btn btn-out" onclick="clearProdForm()">${t('btn_clear_form')}</button>
      <button class="btn btn-pr" onclick="saveProd()">${t('btn_save_prod')}</button>
    </div>
  </div>
</div>`;
  renderInvTable();
}

function invTab(tab,btn){
  document.querySelectorAll('#inv-body .tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('inv-tab-all').style.display=tab==='all'?'block':'none';
  document.getElementById('inv-tab-add').style.display=tab==='add'?'block':'none';
}

function invSearch(v){renderInvTable(v)}

function renderInvTable(filter=''){
  const tbody=document.getElementById('inv-tbody');if(!tbody)return;
  let list=filter?State.products.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())||(p.type||'').toLowerCase().includes(filter.toLowerCase())):State.products;
  tbody.innerHTML=list.length?list.map((p,i)=>`
<tr>
  <td>${i+1}</td><td><strong>${p.name}</strong></td><td>${p.type||'-'}</td>
  <td>${p.buyPrice} ${State.settings.currency}</td><td>${p.sellPrice} ${State.settings.currency}</td><td>${p.qty}</td>
  <td><span class="badge ${p.qty<=0?'badge-er':p.qty<=5?'badge-wa':'badge-ok'}">${p.qty<=0?t('status_oos'):p.qty<=5?t('status_low'):t('status_ok')}</span></td>
  <td>
    <button class="btn btn-sm btn-pr" onclick="editProd('${p.id}')">${t('btn_edit')}</button>
    <button class="btn btn-sm btn-er" onclick="deleteProd('${p.id}')">${t('btn_delete')}</button>
  </td>
</tr>`).join(''):`<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--mu)">0</td></tr>`;
}

function saveProd(){
  const name=document.getElementById('p-name').value.trim();
  const type=document.getElementById('p-type').value.trim();
  const unit=document.getElementById('p-unit').value;
  const buy=parseFloat(document.getElementById('p-buy').value)||0;
  const sell=parseFloat(document.getElementById('p-sell').value)||0;
  const qty=parseInt(document.getElementById('p-qty').value)||0;
  const notif=document.getElementById('inv-add-notif');
  if(!name){if(notif)notif.innerHTML=`<div class="notif-item notif-er">${t('prod_required')}</div>`;return;}
  if(State.products.find(p=>p.name.toLowerCase()===name.toLowerCase())){
    if(notif)notif.innerHTML=`<div class="notif-item notif-wa">${t('prod_exists')}: ${name}</div>`;return;
  }
  if(sell<buy&&notif)notif.innerHTML=`<div class="notif-item notif-wa">${t('prod_sell_low')}</div>`;
  State.products.push({id:Date.now().toString(),name,type,unit,buyPrice:buy,sellPrice:sell,qty,createdAt:new Date().toISOString()});
  saveState();clearProdForm();renderInvTable();
  if(notif)notif.innerHTML=`<div class="notif-item notif-ok">${t('btn_save_prod')}: ${name}</div>`;
  toast(t('toast_saved'),'ok');Snd.ok();
}

function clearProdForm(){
  ['p-name','p-type','p-buy','p-sell','p-qty'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  const u=document.getElementById('p-unit');if(u)u.value='';
  const n=document.getElementById('inv-add-notif');if(n)n.innerHTML='';
}

function editProd(id){
  Snd.click();
  const p=State.products.find(x=>x.id===id);if(!p)return;
  const name=prompt(t('lbl_prod_name'),p.name);if(name===null)return;
  const buy=parseFloat(prompt(t('lbl_buy_price'),p.buyPrice))||p.buyPrice;
  const sell=parseFloat(prompt(t('lbl_sell_price'),p.sellPrice))||p.sellPrice;
  const qty=parseInt(prompt(t('lbl_quantity'),p.qty));if(isNaN(qty))return;
  p.name=name||p.name;p.buyPrice=buy;p.sellPrice=sell;p.qty=qty;
  saveState();renderInvTable();renderProducts();toast(t('toast_saved'),'ok');
}

function deleteProd(id){
  showConfirm(t('btn_delete'),t('confirm_delete_prod'),()=>{
    State.products=State.products.filter(p=>p.id!==id);
    saveState();renderInvTable();renderProducts();toast(t('toast_deleted'),'wa');
  });
}

/* ================================================================
   DEBTS & DELIVERY PAGE
   ================================================================ */
function renderDebts(){
  const body=document.getElementById('debts-body');if(!body)return;
  body.innerHTML=`
<div class="tabs">
  <button class="tab-btn active" onclick="debtsTab('debts',this)">${t('tab_debts')}</button>
  <button class="tab-btn" onclick="debtsTab('delivery',this)">${t('tab_delivery')}</button>
</div>
<div id="debts-tab-debts"><div id="debts-tbl-wrap"></div></div>
<div id="debts-tab-delivery" style="display:none"><div id="delivery-tbl-wrap"></div></div>`;
  renderDebtsTable();renderDeliveryTable();
}

function debtsTab(tab,btn){
  document.querySelectorAll('#debts-body .tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('debts-tab-debts').style.display=tab==='debts'?'block':'none';
  document.getElementById('debts-tab-delivery').style.display=tab==='delivery'?'block':'none';
}

function renderDebtsTable(){
  const wrap=document.getElementById('debts-tbl-wrap');if(!wrap)return;
  if(!State.internalDebts.length){wrap.innerHTML=`<div class="notif-box"><span style="color:var(--mu)">0</span></div>`;return;}
  wrap.innerHTML=`<div class="tbl-wrap"><table class="tbl">
<thead><tr>
  <th>${t('col_name')}</th><th>${t('col_phone')}</th>
  <th>${t('lbl_debt_amount')}</th><th>${t('col_paid')}</th><th>${t('col_remain')}</th>
  <th>${t('col_date')}</th><th>${t('col_actions')}</th>
</tr></thead>
<tbody>${State.internalDebts.map(d=>`
<tr>
  <td><strong>${d.name}</strong></td><td>${d.phone}</td>
  <td>${(d.amount||0).toFixed(2)} ${State.settings.currency}</td>
  <td>${(d.paid||0).toFixed(2)} ${State.settings.currency}</td>
  <td><span class="badge ${(d.remaining||0)<=0?'badge-ok':'badge-er'}">${(d.remaining||0).toFixed(2)} ${State.settings.currency}</span></td>
  <td>${fmtDate(d.date)}</td>
  <td style="display:flex;gap:4px;flex-wrap:wrap">
    ${(d.remaining||0)>0?`<button class="btn btn-sm btn-ok" onclick="payDebt('${d.id}',true)">${t('btn_pay_full')}</button>
    <button class="btn btn-sm btn-wa" onclick="payDebt('${d.id}',false)">${t('btn_pay_partial')}</button>`:''}
    <button class="btn btn-sm btn-pr" onclick="editDebt('${d.id}')">${t('btn_edit')}</button>
    <button class="btn btn-sm btn-er" onclick="deleteDebt('${d.id}')">${t('btn_delete')}</button>
  </td>
</tr>`).join('')}
</tbody></table></div>`;
}

function payDebt(id,full){
  Snd.click();
  const d=State.internalDebts.find(x=>x.id===id);if(!d)return;
  let amount=d.remaining||0;
  if(!full){
    const v=parseFloat(prompt(t('partial_pay_prompt'),amount));
    if(!v||v<=0)return;amount=Math.min(v,d.remaining||0);
  }
  d.paid=(d.paid||0)+amount;d.remaining=Math.max(0,(d.remaining||0)-amount);
  // Add to sales
  const sale={id:Date.now(),invoiceNum:d.invoiceNum||'#DEBT',type:full?'debt_payment':'partial_payment',
    total:amount,buyTotal:0,profit:amount,date:new Date().toISOString(),
    customerName:d.name,items:[],user:State.currentUser?.name||'admin'};
  State.sales.push(sale);State.todaySales.push(sale);
  saveState();renderDebtsTable();toast(t('toast_saved'),'ok');Snd.ok();
}

function editDebt(id){
  Snd.click();
  const d=State.internalDebts.find(x=>x.id===id);if(!d)return;
  const name=prompt(t('col_name'),d.name);if(name===null)return;
  const phone=prompt(t('col_phone'),d.phone)||d.phone;
  const amount=parseFloat(prompt(t('lbl_debt_amount'),d.amount))||d.amount;
  d.name=name||d.name;d.phone=phone;d.amount=amount;d.remaining=Math.max(0,amount-(d.paid||0));
  saveState();renderDebtsTable();toast(t('toast_saved'),'ok');
}

function deleteDebt(id){
  showConfirm(t('btn_delete'),t('confirm_delete_debt'),()=>{
    State.internalDebts=State.internalDebts.filter(d=>d.id!==id);
    saveState();renderDebtsTable();toast(t('toast_deleted'),'wa');
  });
}

function renderDeliveryTable(){
  const wrap=document.getElementById('delivery-tbl-wrap');if(!wrap)return;
  if(!State.deliveries.length){wrap.innerHTML=`<div class="notif-box"><span style="color:var(--mu)">0</span></div>`;return;}
  wrap.innerHTML=`<div class="tbl-wrap"><table class="tbl">
<thead><tr>
  <th>${t('col_name')}</th><th>${t('col_phone')}</th><th>${t('col_address')}</th>
  <th>${t('col_company')}</th><th>${t('lbl_sell_total')}</th>
  <th>${t('col_date')}</th><th>${t('col_status')}</th><th>${t('col_actions')}</th>
</tr></thead>
<tbody>${State.deliveries.map(d=>`
<tr>
  <td><strong>${d.name}</strong></td><td>${d.phone}</td><td>${d.address}${d.wilaya?' - '+d.wilaya:''}</td>
  <td>${d.company||'-'}</td>
  <td>${(d.cartTotal||d.prodPrice||0).toFixed(2)} ${State.settings.currency}</td>
  <td>${fmtDate(d.date)}</td>
  <td><span class="badge ${d.status==='paid'?'badge-ok':'badge-wa'}">${d.status==='paid'?t('btn_pay_full'):t('btn_deliver')}</span></td>
  <td style="display:flex;gap:4px;flex-wrap:wrap">
    ${d.status!=='paid'?`<button class="btn btn-sm btn-ok" onclick="payDelivery('${d.id}')">${t('btn_pay_full')}</button>`:''}
    <button class="btn btn-sm btn-pr" onclick="editDelivery('${d.id}')">${t('btn_edit')}</button>
    <button class="btn btn-sm btn-er" onclick="deleteDelivery('${d.id}')">${t('btn_delete')}</button>
  </td>
</tr>`).join('')}
</tbody></table></div>`;
}

function payDelivery(id){
  Snd.click();
  const d=State.deliveries.find(x=>x.id===id);if(!d)return;
  d.status='paid';
  const sale={id:Date.now(),invoiceNum:d.invoiceNum||'#DEL',type:'delivery_paid',
    total:d.cartTotal||d.prodPrice||0,buyTotal:0,profit:d.cartTotal||0,
    date:new Date().toISOString(),customerName:d.name,items:d.items||[],user:State.currentUser?.name||'admin'};
  State.sales.push(sale);State.todaySales.push(sale);
  saveState();renderDeliveryTable();toast(t('toast_saved'),'ok');Snd.ok();
}

function editDelivery(id){
  Snd.click();
  const d=State.deliveries.find(x=>x.id===id);if(!d)return;
  const name=prompt(t('col_name'),d.name);if(name===null)return;
  const phone=prompt(t('col_phone'),d.phone)||d.phone;
  const address=prompt(t('col_address'),d.address)||d.address;
  d.name=name||d.name;d.phone=phone;d.address=address;
  saveState();renderDeliveryTable();toast(t('toast_saved'),'ok');
}

function deleteDelivery(id){
  showConfirm(t('btn_delete'),t('confirm_delete_delivery'),()=>{
    State.deliveries=State.deliveries.filter(d=>d.id!==id);
    saveState();renderDeliveryTable();toast(t('toast_deleted'),'wa');
  });
}

/* ================================================================
   BUSINESS PAGE
   ================================================================ */
function renderBusiness(){
  const body=document.getElementById('business-body');if(!body)return;
  // Stats
  const todaySales=State.todaySales;
  const rev=todaySales.reduce((s,i)=>s+(i.total||0),0);
  const buy=todaySales.reduce((s,i)=>s+(i.buyTotal||0),0);
  const profit=todaySales.reduce((s,i)=>s+(i.profit||0),0);
  const items=todaySales.reduce((s,i)=>s+(i.items?.reduce((a,b)=>a+b.qty,0)||0),0);
  const totalDebt=State.internalDebts.reduce((s,d)=>s+(d.remaining||0),0);
  const debtors=State.internalDebts.filter(d=>(d.remaining||0)>0).length;
  const pendingDel=State.deliveries.filter(d=>d.status!=='paid');
  const delTotal=pendingDel.reduce((s,d)=>s+(d.cartTotal||0),0);

  body.innerHTML=`
<div class="cards-row">
  <div class="stat-card"><div class="sc-accent"></div><div class="sc-val">${rev.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_daily_income')}</div></div>
  <div class="stat-card"><div class="sc-accent" style="background:var(--ok)"></div><div class="sc-val">${profit.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_profit')}</div></div>
  <div class="stat-card"><div class="sc-accent" style="background:var(--wa)"></div><div class="sc-val">${items}</div><div class="sc-lbl">${t('lbl_items_sold')}</div></div>
  <div class="stat-card"><div class="sc-accent" style="background:var(--er)"></div><div class="sc-val">${totalDebt.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_total_debts')} (${debtors} ${t('lbl_debtors')})</div></div>
  <div class="stat-card"><div class="sc-accent" style="background:var(--in)"></div><div class="sc-val">${delTotal.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_delivery_total')} (${pendingDel.length})</div></div>
</div>
<div class="tabs">
  <button class="tab-btn active" onclick="bizTab('day',this)">${t('tab_day')}</button>
  <button class="tab-btn" onclick="bizTab('week',this)">${t('tab_week')}</button>
  <button class="tab-btn" onclick="bizTab('month',this)">${t('tab_month')}</button>
  <button class="tab-btn" onclick="bizTab('year',this)">${t('tab_year')}</button>
  <button class="tab-btn" onclick="bizTab('prods',this)">${t('tab_products_rep')}</button>
</div>
<div id="biz-content"></div>
<div style="margin-top:14px;padding:14px;background:var(--card);border-radius:var(--r);border:1px solid var(--bd)">
  <strong style="font-size:.9rem">${t('btn_close_day')}</strong>
  <p style="color:var(--mu);font-size:.8rem;margin:6px 0 10px">${t('lbl_partial_clear_desc')}</p>
  <button class="btn btn-er" onclick="closeDay()">${t('btn_close_day')}</button>
</div>`;
  bizTab('day',document.querySelector('#business-body .tab-btn'));
}

function bizTab(tab,btn){
  if(btn){document.querySelectorAll('#business-body .tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
  const c=document.getElementById('biz-content');if(!c)return;
  if(tab==='day')c.innerHTML=renderSalesTable(State.todaySales,true);
  else if(tab==='week')c.innerHTML=renderSalesTable(State.sales.filter(s=>new Date(s.date)>=new Date(Date.now()-7*864e5)),false);
  else if(tab==='month')c.innerHTML=renderSalesTable(State.sales.filter(s=>new Date(s.date)>=new Date(Date.now()-30*864e5)),false);
  else if(tab==='year')c.innerHTML=renderYearReport();
  else if(tab==='prods')c.innerHTML=renderProdsReport();
}

function renderSalesTable(sales,canCancel){
  if(!sales.length)return `<div class="notif-box"><span style="color:var(--mu)">0</span></div>`;
  const rev=sales.reduce((s,i)=>s+(i.total||0),0);
  const prof=sales.reduce((s,i)=>s+(i.profit||0),0);
  const today=new Date().toDateString();
  return `
<div class="cards-row" style="margin-top:10px">
  <div class="stat-card"><div class="sc-accent"></div><div class="sc-val">${rev.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_sell_total')}</div></div>
  <div class="stat-card"><div class="sc-accent" style="background:var(--ok)"></div><div class="sc-val">${prof.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_profit')}</div></div>
</div>
<div class="tbl-wrap"><table class="tbl">
<thead><tr>
  <th>${t('col_invoice')}</th><th>${t('col_type')}</th><th>${t('col_products')}</th>
  <th>${t('col_buy')}</th><th>${t('col_sell')}</th><th>${t('col_profit')}</th>
  <th>${t('col_time')}</th>${canCancel?`<th>${t('btn_cancel_sale')}</th>`:''}
</tr></thead>
<tbody>${sales.map(s=>`
<tr>
  <td>${s.invoiceNum||'-'}</td><td>${txType(s.type)}</td>
  <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.items?s.items.map(i=>i.name).join(', '):s.customerName||'-'}</td>
  <td>${(s.buyTotal||0).toFixed(2)} ${State.settings.currency}</td>
  <td>${(s.total||0).toFixed(2)} ${State.settings.currency}</td>
  <td>${(s.profit||0).toFixed(2)} ${State.settings.currency}</td>
  <td>${new Date(s.date).toLocaleTimeString('ar-DZ')}</td>
  ${canCancel&&new Date(s.date).toDateString()===today?`<td><button class="btn btn-sm btn-er" onclick="cancelSale('${s.id}')">${t('btn_cancel_sale')}</button></td>`:canCancel?'<td>-</td>':''}
</tr>`).join('')}
</tbody></table></div>`;
}

function renderYearReport(){
  const months_ar=['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
  const months_fr=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
  const months=State.lang==='fr'?months_fr:months_ar;
  const yr=new Date().getFullYear();
  const data=months.map((m,i)=>{
    const ms=State.sales.filter(s=>{const d=new Date(s.date);return d.getFullYear()===yr&&d.getMonth()===i;});
    return{m,rev:ms.reduce((s,x)=>s+(x.total||0),0),prof:ms.reduce((s,x)=>s+(x.profit||0),0),cnt:ms.length};
  });
  return `<div class="tbl-wrap"><table class="tbl">
<thead><tr><th>${t('tab_month')}</th><th>${t('col_sell')}</th><th>${t('col_profit')}</th><th>#</th></tr></thead>
<tbody>${data.map(d=>`<tr><td>${d.m}</td><td>${d.rev.toFixed(2)} ${State.settings.currency}</td><td>${d.prof.toFixed(2)} ${State.settings.currency}</td><td>${d.cnt}</td></tr>`).join('')}
</tbody></table></div>`;
}

function renderProdsReport(){
  const items=State.sales.flatMap(s=>s.items||[]);
  const grp={};
  items.forEach(i=>{
    if(!grp[i.name])grp[i.name]={name:i.name,qty:0,rev:0};
    grp[i.name].qty+=i.qty;grp[i.name].rev+=i.total;
  });
  const sorted=Object.values(grp).sort((a,b)=>b.qty-a.qty);
  const low=State.products.filter(p=>p.qty<=5);
  return `
<h4 style="margin:10px 0 8px">${t('top_selling')}</h4>
<div class="tbl-wrap"><table class="tbl">
<thead><tr><th>#</th><th>${t('col_name')}</th><th>${t('col_qty')}</th><th>${t('lbl_sell_total')}</th></tr></thead>
<tbody>${sorted.slice(0,10).map((p,i)=>`<tr><td>${i+1}</td><td>${p.name}</td><td>${p.qty}</td><td>${p.rev.toFixed(2)} ${State.settings.currency}</td></tr>`).join('')||`<tr><td colspan="4" style="text-align:center;padding:16px;color:var(--mu)">0</td></tr>`}
</tbody></table></div>
<h4 style="margin:10px 0 8px">${t('low_stock')}</h4>
<div class="tbl-wrap"><table class="tbl">
<thead><tr><th>${t('col_name')}</th><th>${t('col_qty')}</th><th>${t('col_status')}</th></tr></thead>
<tbody>${low.map(p=>`<tr><td>${p.name}</td><td>${p.qty}</td><td><span class="badge ${p.qty<=0?'badge-er':'badge-wa'}">${p.qty<=0?t('status_oos'):t('status_low')}</span></td></tr>`).join('')||`<tr><td colspan="3" style="text-align:center;padding:16px;color:var(--mu)">-</td></tr>`}
</tbody></table></div>`;
}

function txType(type){
  const m={cash:t('btn_pay'),delivery:t('btn_deliver'),debt:t('btn_debt'),debt_payment:t('btn_pay_full'),partial_payment:t('btn_pay_partial'),delivery_paid:t('btn_deliver')};
  return m[type]||type;
}

function cancelSale(id){
  showConfirm(t('btn_cancel_sale'),t('confirm_cancel_sale'),()=>{
    const idx=State.sales.findIndex(s=>s.id==id);if(idx===-1)return;
    const sale=State.sales[idx];
    (sale.items||[]).forEach(item=>{const p=State.products.find(x=>x.id===item.id);if(p)p.qty+=item.qty;});
    State.sales.splice(idx,1);
    State.todaySales=State.todaySales.filter(s=>s.id!=id);
    saveState();renderBusiness();toast(t('toast_deleted'),'wa');
  });
}

function closeDay(){
  showConfirm(t('btn_close_day'),t('confirm_close_day'),()=>{
    State.todaySales=[];State.invoiceCounter=1;
    DB.s('today_sales',[]);DB.s('invoice_counter',1);
    renderBusiness();toast(t('toast_saved'),'ok');Snd.ok();
  });
}

/* ================================================================
   USERS PAGE
   ================================================================ */
function renderUsers(){
  const body=document.getElementById('users-body');if(!body)return;
  const isAdmin=State.currentUser?.role==='admin';
  if(!isAdmin){body.innerHTML=`<div class="notif-box"><div class="notif-item notif-er">Access denied</div></div>`;return;}
  body.innerHTML=`
<div style="display:flex;justify-content:flex-end;margin-bottom:12px">
  <button class="btn btn-pr" onclick="showAddUserForm()">${t('btn_add_user')}</button>
</div>
<div id="users-form" style="display:none;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px;margin-bottom:14px">
  <div class="form-row">
    <div class="form-group"><label>${t('lbl_fullname')}</label><input type="text" id="u-name"></div>
    <div class="form-group"><label>${t('lbl_username')}</label><input type="text" id="u-user"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>${t('lbl_password')}</label><input type="password" id="u-pass"></div>
    <div class="form-group"><label>${t('lbl_role')}</label>
      <select id="u-role">
        <option value="manager">${t('role_manager')}</option>
        <option value="seller">${t('role_seller')}</option>
      </select>
    </div>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-pr" onclick="saveUser()">${t('btn_save')}</button>
    <button class="btn btn-out" onclick="document.getElementById('users-form').style.display='none'">${t('btn_cancel')}</button>
  </div>
</div>
<div class="tbl-wrap"><table class="tbl">
<thead><tr><th>${t('lbl_fullname')}</th><th>${t('lbl_username')}</th><th>${t('lbl_role')}</th><th>${t('col_actions')}</th></tr></thead>
<tbody id="users-tbody"></tbody>
</table></div>`;
  renderUsersTable();
}

function renderUsersTable(){
  const tbody=document.getElementById('users-tbody');if(!tbody)return;
  const roles={admin:t('role_admin'),manager:t('role_manager'),seller:t('role_seller')};
  tbody.innerHTML=State.users.map(u=>`
<tr>
  <td>${u.name}</td><td>${u.username}</td>
  <td><span class="badge badge-pr">${roles[u.role]||u.role}</span></td>
  <td>
    ${u.role!=='admin'?`<button class="btn btn-sm btn-er" onclick="deleteUser(${u.id})">${t('btn_delete')}</button>`:''}
    <button class="btn btn-sm btn-out" onclick="changeUserPass(${u.id})">${t('lbl_password')}</button>
  </td>
</tr>`).join('');
}

function showAddUserForm(){document.getElementById('users-form').style.display='block'}

function saveUser(){
  const name=document.getElementById('u-name').value.trim();
  const username=document.getElementById('u-user').value.trim();
  const pass=document.getElementById('u-pass').value;
  const role=document.getElementById('u-role').value;
  if(!name||!username||!pass){toast(t('prod_required'),'er');return;}
  if(State.users.find(u=>u.username===username)){toast(t('prod_exists'),'wa');return;}
  State.users.push({id:Date.now(),name,username,password:pass,role});
  saveState();renderUsersTable();document.getElementById('users-form').style.display='none';
  toast(t('toast_saved'),'ok');Snd.ok();
}

function deleteUser(id){
  showConfirm(t('btn_delete'),t('confirm_delete_prod'),()=>{
    State.users=State.users.filter(u=>u.id!==id);saveState();renderUsersTable();toast(t('toast_deleted'),'wa');
  });
}

function changeUserPass(id){
  const u=State.users.find(x=>x.id===id);if(!u)return;
  const p=prompt(t('lbl_password'),u.password);if(!p)return;
  u.password=p;saveState();toast(t('toast_saved'),'ok');
}

/* ================================================================
   EXTERNAL DEBTS PAGE
   ================================================================ */
function renderExtDebts(){
  const body=document.getElementById('extdebts-body');if(!body)return;
  const total=State.externalDebts.reduce((s,d)=>s+(d.remaining||0),0);
  body.innerHTML=`
<div class="cards-row">
  <div class="stat-card"><div class="sc-accent" style="background:var(--er)"></div><div class="sc-val">${total.toFixed(2)} ${State.settings.currency}</div><div class="sc-lbl">${t('lbl_total_debts')}</div></div>
</div>
<div style="display:flex;justify-content:flex-end;margin-bottom:12px">
  <button class="btn btn-pr" onclick="showExtDebtForm()">${t('btn_add_extdebt')}</button>
</div>
<div id="ext-form" style="display:none;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px;margin-bottom:14px">
  <div class="form-row">
    <div class="form-group"><label>${t('lbl_ext_name')}</label><input type="text" id="ed-name"></div>
    <div class="form-group"><label>${t('lbl_ext_phone')}</label><input type="tel" id="ed-phone"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>${t('lbl_ext_amount')} *</label><input type="number" id="ed-amount" min="0" placeholder="0"></div>
    <div class="form-group"><label>${t('lbl_ext_note')}</label><input type="text" id="ed-note"></div>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-pr" onclick="saveExtDebt()">${t('btn_save')}</button>
    <button class="btn btn-out" onclick="document.getElementById('ext-form').style.display='none'">${t('btn_cancel')}</button>
  </div>
</div>
<div class="tbl-wrap"><table class="tbl">
<thead><tr>
  <th>${t('lbl_ext_name')}</th><th>${t('lbl_ext_phone')}</th>
  <th>${t('lbl_ext_amount')}</th><th>${t('col_paid')}</th><th>${t('col_remain')}</th>
  <th>${t('lbl_ext_note')}</th><th>${t('col_actions')}</th>
</tr></thead>
<tbody id="ext-tbody"></tbody>
</table></div>`;
  renderExtTable();
}

function renderExtTable(){
  const tbody=document.getElementById('ext-tbody');if(!tbody)return;
  tbody.innerHTML=State.externalDebts.length?State.externalDebts.map(d=>`
<tr>
  <td><strong>${d.name||'-'}</strong></td><td>${d.phone||'-'}</td>
  <td>${(d.amount||0).toFixed(2)} ${State.settings.currency}</td>
  <td>${(d.paid||0).toFixed(2)} ${State.settings.currency}</td>
  <td><span class="badge ${(d.remaining||0)<=0?'badge-ok':'badge-er'}">${(d.remaining||0).toFixed(2)} ${State.settings.currency}</span></td>
  <td>${d.note||'-'}</td>
  <td style="display:flex;gap:4px;flex-wrap:wrap">
    ${(d.remaining||0)>0?`<button class="btn btn-sm btn-ok" onclick="payExtDebt('${d.id}',true)">${t('btn_pay_full')}</button>
    <button class="btn btn-sm btn-wa" onclick="payExtDebt('${d.id}',false)">${t('btn_pay_partial')}</button>`:''}
    <button class="btn btn-sm btn-er" onclick="deleteExtDebt('${d.id}')">${t('btn_delete')}</button>
  </td>
</tr>`).join(''):`<tr><td colspan="7" style="text-align:center;padding:18px;color:var(--mu)">0</td></tr>`;
}

function showExtDebtForm(){document.getElementById('ext-form').style.display='block'}

function saveExtDebt(){
  const name=document.getElementById('ed-name').value.trim();
  const phone=document.getElementById('ed-phone').value.trim();
  const amount=parseFloat(document.getElementById('ed-amount').value)||0;
  const note=document.getElementById('ed-note').value.trim();
  if(!amount){toast(t('prod_required'),'er');return;}
  State.externalDebts.push({id:Date.now().toString(),name,phone,amount,paid:0,remaining:amount,note,date:new Date().toISOString()});
  saveState();document.getElementById('ext-form').style.display='none';
  ['ed-name','ed-phone','ed-amount','ed-note'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  renderExtDebts();toast(t('toast_saved'),'ok');Snd.ok();
}

function payExtDebt(id,full){
  Snd.click();
  const d=State.externalDebts.find(x=>x.id===id);if(!d)return;
  let amount=d.remaining||0;
  if(!full){const v=parseFloat(prompt(t('partial_pay_prompt'),amount));if(!v||v<=0)return;amount=Math.min(v,d.remaining||0);}
  d.paid=(d.paid||0)+amount;d.remaining=Math.max(0,(d.remaining||0)-amount);
  saveState();renderExtTable();toast(t('toast_saved'),'ok');Snd.ok();
}

function deleteExtDebt(id){
  showConfirm(t('btn_delete'),t('confirm_delete_debt'),()=>{
    State.externalDebts=State.externalDebts.filter(d=>d.id!==id);
    saveState();renderExtDebts();toast(t('toast_deleted'),'wa');
  });
}

/* ================================================================
   SETTINGS PAGE
   ================================================================ */
function renderSettings(){
  const body=document.getElementById('settings-body');if(!body)return;
  body.innerHTML=`
<div class="stg-tabs">
  <button class="stg-tab active" onclick="stgTab('program',this)">${t('stg_program')}</button>
  <button class="stg-tab" onclick="stgTab('store',this)">${t('stg_store')}</button>
  <button class="stg-tab" onclick="stgTab('notifs',this)">${t('stg_notifs')}</button>
  <button class="stg-tab" onclick="stgTab('system',this)">${t('stg_system')}</button>
  <button class="stg-tab" onclick="stgTab('about',this)">${t('stg_about')}</button>
</div>
<div id="stg-content"></div>`;
  stgTab('program',document.querySelector('#settings-body .stg-tab'));
}

function stgTab(tab,btn){
  if(btn){document.querySelectorAll('#settings-body .stg-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
  const c=document.getElementById('stg-content');if(!c)return;
  const s=State.settings;
  if(tab==='program'){
    c.innerHTML=`
<div style="max-width:580px">
  <div class="form-group"><label>${t('lbl_date_format')}</label>
    <select onchange="s_set('dateFormat',this.value)">
      <option value="dmy" ${s.dateFormat==='dmy'?'selected':''}>يوم/شهر/سنة - JJ/MM/AAAA</option>
      <option value="mdy" ${s.dateFormat==='mdy'?'selected':''}>شهر/يوم/سنة - MM/JJ/AAAA</option>
      <option value="ymd" ${s.dateFormat==='ymd'?'selected':''}>سنة/شهر/يوم - AAAA/MM/JJ</option>
    </select>
  </div>
  <div class="form-group"><label>${t('lbl_currency')}</label>
    <select onchange="s_set('currency',this.value)">
      <option value="دج" ${s.currency==='دج'?'selected':''}>دج - دينار جزائري</option>
      <option value="ر.س" ${s.currency==='ر.س'?'selected':''}>ر.س - ريال سعودي</option>
      <option value="ر.إ" ${s.currency==='ر.إ'?'selected':''}>ر.إ - درهم إماراتي</option>
      <option value="ج.م" ${s.currency==='ج.م'?'selected':''}>ج.م - جنيه مصري</option>
      <option value="د.م" ${s.currency==='د.م'?'selected':''}>د.م - درهم مغربي</option>
      <option value="د.ت" ${s.currency==='د.ت'?'selected':''}>د.ت - دينار تونسي</option>
      <option value="€" ${s.currency==='€'?'selected':''}>€ - Euro</option>
      <option value="$" ${s.currency==='$'?'selected':''}>$ - Dollar</option>
    </select>
  </div>
  <div class="form-group"><label>${t('lbl_lang')}</label>
    <select onchange="changeLang(this.value)">
      <option value="ar" ${s.lang==='ar'?'selected':''}>العربية - AR</option>
      <option value="fr" ${s.lang==='fr'?'selected':''}>Français - FR</option>
    </select>
  </div>
  <div class="form-group"><label>${t('lbl_theme')}</label>
    <select onchange="s_set('theme',this.value);applySettings()">
      <option value="light" ${s.theme==='light'?'selected':''}>Mode Jour - فاتح</option>
      <option value="dark" ${s.theme==='dark'?'selected':''}>Mode Nuit - داكن</option>
    </select>
  </div>
  <div class="form-group"><label>${t('lbl_color')}</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
      ${[{v:'default',bg:'linear-gradient(135deg,#6c63ff,#00d4ff)',l:'Default'},{v:'green',bg:'#00b894',l:'Vert'},{v:'blue',bg:'#0984e3',l:'Bleu'},{v:'orange',bg:'#e17055',l:'Orange'},{v:'red',bg:'#d63031',l:'Rouge'}].map(c=>`<div class="color-swatch ${s.color===c.v?'active':''}" style="background:${c.bg}" title="${c.l}" onclick="s_set('color','${c.v}');applySettings();document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('active'));this.classList.add('active')"></div>`).join('')}
    </div>
  </div>
  <div class="form-group"><label>${t('lbl_font_size')}</label>
    <div style="display:flex;align-items:center;gap:10px">
      <button class="btn btn-out btn-sm" onclick="chFont(-1)">-</button>
      <span id="font-size-val">${s.fontSize}px</span>
      <button class="btn btn-out btn-sm" onclick="chFont(1)">+</button>
    </div>
  </div>
  <div style="margin-top:14px">
    <strong style="font-size:.88rem">${t('lbl_sound')}</strong>
    <div class="tog-wrap" style="margin-top:8px">
      <label>${t('lbl_sound_enable')}</label>
      <label class="toggle"><input type="checkbox" ${s.soundEnabled?'checked':''} onchange="s_set('soundEnabled',this.checked)"><span class="tog-sl"></span></label>
    </div>
  </div>
  <button class="btn btn-pr" style="margin-top:14px" onclick="saveSettings()">${t('btn_save')}</button>
</div>`;
  } else if(tab==='store'){
    c.innerHTML=`
<div style="max-width:580px">
  <div class="form-group"><label>${t('lbl_store_logo')}</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="file" id="stg-logo" accept="image/*" onchange="uploadLogo(this)">
      ${s.logoUrl?`<img src="${s.logoUrl}" style="height:44px;border-radius:8px;border:1px solid var(--bd)"><button class="btn btn-sm btn-er" onclick="s_set('logoUrl','');renderSettings()">X</button>`:''}
    </div>
  </div>
  <div class="form-group"><label>${t('lbl_store_name')}</label><input type="text" id="stg-sname" value="${s.storeName}" oninput="s_set('storeName',this.value);updateStoreName()"></div>
  <div class="form-group"><label>${t('lbl_store_phone')}</label><input type="tel" id="stg-phone" value="${s.phone||''}"></div>
  <div class="form-group"><label>${t('lbl_store_addr')}</label><input type="text" id="stg-addr" value="${s.address||''}"></div>
  <div class="form-group"><label>${t('lbl_welcome_msg')}</label><textarea id="stg-welcome" rows="2">${s.welcomeMsg||''}</textarea></div>
  <button class="btn btn-pr" onclick="saveStoreSettings()">${t('btn_save')}</button>
</div>`;
  } else if(tab==='notifs'){
    c.innerHTML=`
<div style="max-width:580px">
  <div class="tog-wrap"><label>${t('lbl_notif_stock')}</label><label class="toggle"><input type="checkbox" ${s.notifStock?'checked':''} onchange="s_set('notifStock',this.checked)"><span class="tog-sl"></span></label></div>
  <div class="tog-wrap"><label>${t('lbl_notif_debt')}</label><label class="toggle"><input type="checkbox" ${s.notifDebt!==false?'checked':''} onchange="s_set('notifDebt',this.checked)"><span class="tog-sl"></span></label></div>
  <div class="tog-wrap"><label>${t('lbl_notif_login')}</label><label class="toggle"><input type="checkbox" ${s.notifLogin?'checked':''} onchange="s_set('notifLogin',this.checked)"><span class="tog-sl"></span></label></div>
  <button class="btn btn-pr" style="margin-top:10px" onclick="saveSettings()">${t('btn_save')}</button>
</div>`;
  } else if(tab==='system'){
    c.innerHTML=`
<div style="max-width:580px">
  <div style="background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:15px;margin-bottom:12px">
    <strong>${t('lbl_auto_backup')}</strong>
    <div class="tog-wrap" style="margin:8px 0">
      <label>${t('lbl_auto_backup')}</label>
      <label class="toggle"><input type="checkbox" ${s.autoBackup?'checked':''} onchange="s_set('autoBackup',this.checked)"><span class="tog-sl"></span></label>
    </div>
    <button class="btn btn-pr" onclick="exportData()">${t('btn_export')}</button>
  </div>
  <div style="background:var(--card);border:1px solid rgba(255,165,2,.3);border-radius:var(--r);padding:15px;margin-bottom:12px">
    <strong style="color:var(--wa)">${t('lbl_partial_clear')}</strong>
    <p style="color:var(--mu);font-size:.8rem;margin:6px 0 10px">${t('lbl_partial_clear_desc')}</p>
    <button class="btn btn-wa" onclick="partialClear()">${t('btn_partial_clear')}</button>
  </div>
  <div style="background:var(--card);border:1px solid rgba(255,71,87,.3);border-radius:var(--r);padding:15px">
    <strong style="color:var(--er)">${t('lbl_full_clear')}</strong>
    <p style="color:var(--mu);font-size:.8rem;margin:6px 0 10px">${t('lbl_full_clear_desc')}</p>
    <button class="btn btn-er" onclick="fullClear()">${t('btn_full_clear')}</button>
  </div>
</div>`;
  } else if(tab==='about'){
    c.innerHTML=`
<div style="max-width:480px;margin:0 auto">
  <div class="about-hero">
    <h1>E-Commerce DZ</h1>
    <p>${t('about_title')}</p>
    <div class="meta"><div>${t('about_version')}</div><div>${t('about_year')}</div><div>Windows Support</div></div>
  </div>
  <div class="about-card">
    <div style="font-size:1.3rem;margin-bottom:6px">🔐</div>
    <h4>${t('about_license')}</h4>
    <p style="color:var(--ok);font-weight:700;margin-top:6px">${t('about_active')}</p>
  </div>
  <div class="about-card">
    <h4>${t('about_dev')}</h4>
    <p style="font-weight:700;color:var(--pr);margin-top:6px">${t('about_company')}</p>
    <p style="margin-top:8px"><span style="background:rgba(0,200,100,.12);color:#00c850;padding:5px 14px;border-radius:99px;font-size:.85rem">${t('about_contact')}</span></p>
  </div>
  <div class="about-footer">${t('about_rights')} ®</div>
</div>`;
  }
}

function s_set(k,v){State.settings[k]=v;}

function saveSettings(){DB.s('settings',State.settings);applySettings();toast(t('toast_saved'),'ok');Snd.ok();}

function saveStoreSettings(){
  State.settings.phone=document.getElementById('stg-phone')?.value||'';
  State.settings.address=document.getElementById('stg-addr')?.value||'';
  State.settings.welcomeMsg=document.getElementById('stg-welcome')?.value||'';
  saveSettings();updateStoreName();
}

function uploadLogo(input){
  const f=input.files[0];if(!f)return;
  const r=new FileReader();r.onload=e=>{State.settings.logoUrl=e.target.result;};r.readAsDataURL(f);
}

function changeLang(lang){
  State.settings.lang=lang;State.lang=lang;
  document.documentElement.lang=lang==='fr'?'fr':'ar';
  document.documentElement.dir='rtl';
  saveSettings();renderSettings();updateStoreName();
}

function chFont(d){
  State.settings.fontSize=Math.max(12,Math.min(20,(State.settings.fontSize||15)+d));
  document.documentElement.style.fontSize=State.settings.fontSize+'px';
  const el=document.getElementById('font-size-val');if(el)el.textContent=State.settings.fontSize+'px';
}

function exportData(){
  const data={products:State.products,sales:State.sales,internalDebts:State.internalDebts,deliveries:State.deliveries,externalDebts:State.externalDebts,settings:State.settings,exportDate:new Date().toISOString()};
  const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);
  a.download=`ecdz-backup-${new Date().toLocaleDateString('fr').replace(/\//g,'-')}.json`;a.click();
  toast(t('toast_saved'),'ok');
}

function partialClear(){
  showConfirm(t('lbl_partial_clear'),t('confirm_partial_clear'),()=>{
    State.sales=[];State.todaySales=[];State.internalDebts=[];State.deliveries=[];
    saveState();toast(t('toast_deleted'),'wa');
  });
}

function fullClear(){
  const v=prompt(t('confirm_full_clear'));
  if(v!=='CONFIRM'){toast(t('btn_cancel'),'in');return;}
  State.products=[];State.sales=[];State.todaySales=[];State.internalDebts=[];
  State.deliveries=[];State.externalDebts=[];State.notifications=[];
  State.invoiceCounter=1;saveState();toast(t('toast_deleted'),'wa');
}

/* ================================================================
   APPLY SETTINGS
   ================================================================ */
function applySettings(){
  const s=State.settings;
  document.documentElement.style.fontSize=s.fontSize+'px';
  document.body.classList.toggle('dark',s.theme==='dark');
  document.body.className=document.body.className.replace(/\btheme-\w+\b/g,'').trim();
  if(s.color&&s.color!=='default')document.body.classList.add('theme-'+s.color);
  State.lang=s.lang||'ar';State.currency=s.currency||'دج';
  document.documentElement.lang=s.lang==='fr'?'fr':'ar';
  document.documentElement.dir='rtl';
}

function updateStoreName(){
  const el=document.getElementById('store-hdr-name');
  if(el)el.textContent=State.settings.storeName||'E-Commerce DZ';
}

/* ================================================================
   NOTIFICATIONS
   ================================================================ */
function addNotif(msg,type='in'){
  State.notifications.unshift({msg,type,time:new Date().toISOString(),read:false});
  if(State.notifications.length>60)State.notifications.pop();
  DB.s('notifications',State.notifications);
  updateNotifBadge();Snd.notif();
}

function updateNotifBadge(){
  const badge=document.getElementById('notif-count');
  const unread=State.notifications.filter(n=>!n.read).length;
  if(badge){badge.textContent=unread;badge.style.display=unread>0?'flex':'none';}
}

function checkNotifs(){
  if(State.settings.notifStock){
    State.products.forEach(p=>{
      if(p.qty<=0)addNotif(p.name+': '+t('status_oos'),'er');
      else if(p.qty<=5)addNotif(p.name+': '+t('status_low')+' ('+p.qty+')','wa');
    });
  }
  if(State.settings.notifDebt){
    const weekAgo=Date.now()-7*864e5;
    State.internalDebts.forEach(d=>{
      if((d.remaining||0)>0&&d.date&&new Date(d.date).getTime()<weekAgo){
        addNotif(d.name+': '+t('lbl_total_debts'),'wa');
      }
    });
  }
}

function openNotifPanel(){
  Snd.click();
  State.notifications.forEach(n=>n.read=true);
  DB.s('notifications',State.notifications);updateNotifBadge();
  const list=document.getElementById('notif-list');
  if(!list)return;
  list.innerHTML=State.notifications.length?
    State.notifications.slice(0,30).map(n=>`<div class="notif-item notif-${n.type}" style="margin-bottom:6px">${n.msg}<br><small style="opacity:.6">${fmtDate(n.time)}</small></div>`).join(''):
    `<div style="text-align:center;color:var(--mu);padding:20px">${t('inv_notif_none')}</div>`;
  openModal('notif-modal');
}

function clearNotifs(){State.notifications=[];DB.s('notifications',[]);updateNotifBadge();closeModal('notif-modal');}

/* ================================================================
   VIRTUAL KEYBOARD
   ================================================================ */
let vkbLang='ar';let vkbVisible=false;

const VKB_LAYOUTS={
  ar:[
    ['ض','ص','ث','ق','ف','غ','ع','ه','خ','ح','ج'],
    ['ش','س','ي','ب','ل','ا','ت','ن','م','ك','ط'],
    ['ئ','ء','ؤ','ر','لا','ى','ة','و','ز','ظ','⌫'],
    ['!','؟','.',',','@','-','_','1','2','3','0'],
    ['مسافة','إدخال']
  ],
  fr:[
    ['a','z','e','r','t','y','u','i','o','p'],
    ['q','s','d','f','g','h','j','k','l','m'],
    ['w','x','c','v','b','n','é','è','ê','⌫'],
    ['!','?','.',',','@','-','_','1','2','3','0'],
    ['espace','entrée']
  ],
  num:[['7','8','9'],['4','5','6'],['1','2','3'],['0','.','⌫'],['entrée']],
  sym:['!','@','#','$','%','^','&','*','(',')','_','-','+','=','[',']','{','}','|','\\',':',';','"',"'",'<','>','?','/','~','`','⌫']
};

function toggleVKB(){
  vkbVisible=!vkbVisible;
  document.getElementById('vkb').classList.toggle('show',vkbVisible);
  if(vkbVisible)renderVKB();
}

function setVKBLang(lang){
  vkbLang=lang;
  document.querySelectorAll('.vkb-lang-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('vkb-lang-'+lang)?.classList.add('active');
  renderVKB();
}

function renderVKB(){
  const layout=document.getElementById('vkb-layout');if(!layout)return;
  const rows=VKB_LAYOUTS[vkbLang];
  if(vkbLang==='sym'){
    // symbols
    layout.innerHTML=`<div class="vkb-row" style="flex-wrap:wrap">${rows.map(k=>`<button class="vkb-key" onclick="vkbPress('${k}')">${k}</button>`).join('')}</div>`;
    return;
  }
  layout.innerHTML=rows.map(row=>`<div class="vkb-row">${row.map(k=>{
    const wide=k.length>4?'wider':k.length>2?'wide':'';
    return `<button class="vkb-key ${wide} ${['مسافة','espace','إدخال','entrée'].includes(k)?'special':''}" onclick="vkbPress('${k}')">${k}</button>`;
  }).join('')}</div>`).join('');
}

function vkbPress(key){
  const active=document.activeElement;
  if(!active||!['INPUT','TEXTAREA'].includes(active.tagName))return;
  Snd.click();
  if(key==='⌫')active.value=active.value.slice(0,-1);
  else if(key==='مسافة'||key==='espace')active.value+=' ';
  else if(key==='إدخال'||key==='entrée')active.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter',bubbles:true}));
  else active.value+=key;
  active.dispatchEvent(new Event('input',{bubbles:true}));
}

// Drag VKB
(function(){
  const vkb=document.getElementById('vkb');
  const hdr=document.getElementById('vkb-hdr');
  if(!vkb||!hdr)return;
  let drag=false,ox=0,oy=0;
  hdr.addEventListener('mousedown',e=>{drag=true;ox=e.clientX-vkb.offsetLeft;oy=e.clientY-vkb.offsetTop;e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!drag)return;vkb.style.left=(e.clientX-ox)+'px';vkb.style.top=(e.clientY-oy)+'px';vkb.style.bottom='auto';vkb.style.right='auto';});
  document.addEventListener('mouseup',()=>drag=false);
})();

/* ================================================================
   HELPERS
   ================================================================ */
function fmtDate(iso){
  if(!iso)return '-';
  const d=new Date(iso);const s=State.settings;
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0');
  const min=String(d.getMinutes()).padStart(2,'0');
  const time=hh+':'+min;
  if(s.dateFormat==='mdy')return `${mm}/${dd}/${yyyy} ${time}`;
  if(s.dateFormat==='ymd')return `${yyyy}/${mm}/${dd} ${time}`;
  return `${dd}/${mm}/${yyyy} ${time}`;
}

/* ================================================================
   INIT
   ================================================================ */
window.addEventListener('load',()=>{
  initSnd();startClock();initLogin();
  // Wilaya selects
  fillWilayas(document.getElementById('del-wilaya'));
  fillWilayas(document.getElementById('dbt-wilaya'));
  // VKB keyboard shortcut
  document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='k'){e.preventDefault();toggleVKB();}});
  // Auto-login
  const saved=DB.g('saved_creds');
  if(saved){
    const u=State.users.find(x=>x.username===saved.u&&x.password===saved.p);
    if(u){State.currentUser=u;showApp();}
  }
  // Apply settings
  applySettings();
  // Init divider after short delay
  setTimeout(initDivider,200);
});
</script>
</body>
</html>
